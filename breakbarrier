local connectionName = "Ftap_Barrier_Delete_L_Connection"
local StarterGui = game:GetService("StarterGui")
local UIS = game:GetService("UserInputService")
local Players = game:GetService("Players")
local RS = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local plr = Players.LocalPlayer

-- [ 중복 실행 방지 ] 이미 켜져 있다면 기존 연결을 해제하고 다시 연결
if _G[connectionName] then
    pcall(function() _G[connectionName]:Disconnect() end)
    _G[connectionName] = nil
end

-- [ 알림 ] 기능 활성화 메시지
StarterGui:SetCore("SendNotification", {
    Title = "Ftap Script",
    Text = "Plot5 Barrier Delete: [ ON ] (Key: L)",
    Duration = 3
})

-- 기능 함수 정의
local function PlotBarrierDelete()
    if _G.PBDrun then return end
    _G.PBDrun = true

    local char = plr.Character
    if not char then 
        _G.PBDrun = false 
        return 
    end

    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then 
        _G.PBDrun = false 
        return 
    end

    -- Plot5의 TeslaCoil Metal 찾기
    local plot5 = Workspace:FindFirstChild("Plots") and Workspace.Plots:FindFirstChild("Plot5")
    if not plot5 then
        warn("Plot5 not found")
        _G.PBDrun = false
        return
    end

    local teslaCoil = plot5:FindFirstChild("TeslaCoil")
    local metal = teslaCoil and teslaCoil:FindFirstChild("Metal")

    if not metal then 
        warn("TeslaCoil Metal not found in Plot5")
        _G.PBDrun = false 
        return 
    end

    local TP = metal.CFrame
    local OCF = hrp.CFrame

    -- FoodBread 소환
    task.spawn(function()
        local spawnRemote = RS:FindFirstChild("MenuToys") and RS.MenuToys:FindFirstChild("SpawnToyRemoteFunction")
        if spawnRemote then
            spawnRemote:InvokeServer("FoodBread", hrp.CFrame, Vector3.new(0,0,0))
        end
    end)

    task.wait(0.2)

    local inv = Workspace:FindFirstChild(plr.Name.."SpawnedInToys")
    local foodBread = inv and inv:FindFirstChild("FoodBread")

    if not foodBread then 
        _G.PBDrun = false 
        return 
    end

    -- FoodBread 잡기
    if foodBread then
        task.spawn(function()
            local holdPart = foodBread:FindFirstChild("HoldPart")
            local holdRemote = holdPart and holdPart:FindFirstChild("HoldItemRemoteFunction")
            if holdRemote then
                holdRemote:InvokeServer(foodBread, char)
            end
        end)
    end

    task.wait(0.1)

    -- 텔레포트 및 삭제 로직
    hrp.CFrame = TP
    task.wait(0.17)

    if foodBread then
        local destroyRemote = RS:FindFirstChild("MenuToys") and RS.MenuToys:FindFirstChild("DestroyToy")
        if destroyRemote then
            destroyRemote:FireServer(foodBread)
        end
    end

    hrp.CFrame = OCF
    task.wait(0.4)

    _G.PBDrun = false
end

-- [ 키바인드 연결 ] L키 누르면 실행
_G[connectionName] = UIS.InputBegan:Connect(function(input, processed)
    if not processed and input.KeyCode == Enum.KeyCode.L then
        PlotBarrierDelete()
    end
end)
