local connectionName = "Ftap_Barrier_Delete_L_Connection"
local StarterGui = game:GetService("StarterGui")
local UIS = game:GetService("UserInputService")

-- [ 1. 토글 로직: 이미 실행 중이면 끄고 종료 ] --
if _G[connectionName] then
    -- 연결이 존재하면 연결 해제 (이벤트 수신 중단)
    pcall(function() _G[connectionName]:Disconnect() end)
    _G[connectionName] = nil
    _G.PBDrun = nil -- 실행 중 변수 초기화

    StarterGui:SetCore("SendNotification", {
        Title = "Ftap Script",
        Text = "Plot5 Barrier Delete: [ OFF ]",
        Duration = 3
    })
    return -- 스크립트 여기서 즉시 종료
end

-- [ 2. 실행 로직: 꺼져 있으면 기능 켜기 ] --
StarterGui:SetCore("SendNotification", {
    Title = "Ftap Script",
    Text = "Plot5 Barrier Delete: [ ON ] (Key: L)",
    Duration = 3
})

local Players = game:GetService("Players")
local RS = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local plr = Players.LocalPlayer

-- 기능 함수 정의
local function PlotBarrierDelete()
    if _G.PBDrun then return end
    _G.PBDrun = true

    local char = plr.Character
    if not char then 
        _G.PBDrun = false 
        return 
    end

    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then 
        _G.PBDrun = false 
        return 
    end

    -- Plot5의 TeslaCoil Metal 찾기
    local plot5 = Workspace:FindFirstChild("Plots") and Workspace.Plots:FindFirstChild("Plot5")
    if not plot5 then
        warn("Plot5 not found")
        _G.PBDrun = false
        return
    end

    local teslaCoil = plot5:FindFirstChild("TeslaCoil")
    local metal = teslaCoil and teslaCoil:FindFirstChild("Metal")

    if not metal then 
        warn("TeslaCoil Metal not found in Plot5")
        _G.PBDrun = false 
        return 
    end

    local TP = metal.CFrame
    local OCF = hrp.CFrame

    -- FoodBread 소환
    task.spawn(function()
        local spawnRemote = RS:FindFirstChild("MenuToys") and RS.MenuToys:FindFirstChild("SpawnToyRemoteFunction")
        if spawnRemote then
            spawnRemote:InvokeServer("FoodBread", hrp.CFrame, Vector3.new(0,0,0))
        end
    end)

    task.wait(0.2)

    local inv = Workspace:FindFirstChild(plr.Name.."SpawnedInToys")
    local foodBread = inv and inv:FindFirstChild("FoodBread")

    if not foodBread then 
        _G.PBDrun = false 
        return 
    end

    -- FoodBread 잡기
    if foodBread then
        task.spawn(function()
            local holdPart = foodBread:FindFirstChild("HoldPart")
            local holdRemote = holdPart and holdPart:FindFirstChild("HoldItemRemoteFunction")
            if holdRemote then
                holdRemote:InvokeServer(foodBread, char)
            end
        end)
    end

    task.wait(0.1)

    -- 텔레포트 및 삭제 로직
    hrp.CFrame = TP
    task.wait(0.17)

    if foodBread then
        local destroyRemote = RS:FindFirstChild("MenuToys") and RS.MenuToys:FindFirstChild("DestroyToy")
        if destroyRemote then
            destroyRemote:FireServer(foodBread)
        end
    end

    hrp.CFrame = OCF
    task.wait(0.4)

    _G.PBDrun = false
end

-- [ 3. 키바인드 연결 및 저장 ] --
-- 연결 객체를 전역 변수(_G)에 저장하여 다음에 끄거나 켤 때 참조 가능하게 함
_G[connectionName] = UIS.InputBegan:Connect(function(input, processed)
    if not processed and input.KeyCode == Enum.KeyCode.L then
        PlotBarrierDelete()
    end
end)
