local Players = game:GetService("Players")
local rs = game:GetService("ReplicatedStorage")
local StarterGui = game:GetService("StarterGui")

local plr = Players.LocalPlayer
local inv = workspace[plr.Name .. "SpawnedInToys"]

-- â–¶ ì•Œë¦¼ í•¨ìˆ˜
local function Notify(title, text, duration)
    StarterGui:SetCore("SendNotification", {
        Title = title,
        Text = text,
        Duration = duration or 3,
    })
end

if _G.RGB_State == nil then
    _G.RGB_State = "off"   -- "off" | "starting" | "on"
    _G.RGB_Toggle = false
end

if _G.RGB_State == "on" then
    -- ì¼œì ¸ìˆìŒ â†’ ë„ê¸°
    _G.RGB_Toggle = false
    _G.RGB_State = "off"
    Notify("ğŸ”´ Ragdoll Grab", "Ragdoll Grabì´ êº¼ì¡ŒìŠµë‹ˆë‹¤.", 3)
    return

elseif _G.RGB_State == "starting" then
    -- ì•„ì§ ì¼œì§€ëŠ” ì¤‘
    Notify("âš ï¸ Ragdoll Grab", "ì´ë¯¸ ì¼œì ¸ ìˆìŠµë‹ˆë‹¤!", 3)
    return

elseif _G.RGB_State == "off" then
    -- êº¼ì ¸ìˆìŒ â†’ ì¼œê¸°
    _G.RGB_Toggle = true
    _G.RGB_State = "starting"
    Notify("âœ… Ragdoll Grab", "Ragdoll Grabì´ ì¼œì¡ŒìŠµë‹ˆë‹¤.", 3)
end

-- ================================================
-- RagdollGrabF ë©”ì¸ ë£¨í”„
-- ================================================
local function RagdollGrabF()
    _G.RGB_State = "on"

    if not _G.RGB_Toggle then
        local deskToRemove = inv:FindFirstChild("RB")
        if deskToRemove then
            local destroyRemote = rs:FindFirstChild("MenuToys") and rs.MenuToys:FindFirstChild("DestroyToy")
            if destroyRemote then pcall(function() destroyRemote:FireServer(deskToRemove) end) end
        end
        _G.RGB_State = "off"
        return
    end

    while _G.RGB_Toggle and task.wait() do
        local char = plr.Character
        local hrp = char and char:FindFirstChild("HumanoidRootPart")
        if not hrp then continue end

        local desk = inv:FindFirstChild("RB")

        -- RB(íŒ”ë ˆíŠ¸) ì—†ìœ¼ë©´ ìƒˆë¡œ ìŠ¤í°
        if not desk then
            local spawnRemote = rs.MenuToys and rs.MenuToys:FindFirstChild("SpawnToyRemoteFunction")
            if spawnRemote then
                local offset = hrp.CFrame.LookVector * -24
                local spawnCF = hrp.CFrame + offset

                task.spawn(function()
                    pcall(function()
                        spawnRemote:InvokeServer("PalletLightBrown", spawnCF, spawnCF.Position)
                        task.wait(0.1)
                    end)

                    for _ = 1, 3 do
                        for _, item in pairs(inv:GetChildren()) do
                            if item.Name == "PalletLightBrown" then
                                local soundPart = item:FindFirstChild("SoundPart")
                                if soundPart then
                                    for _ = 1, 3 do
                                        pcall(function()
                                            rs.GrabEvents.SetNetworkOwner:FireServer(soundPart, soundPart.CFrame)
                                            rs.GrabEvents.SetNetworkOwner:FireServer(soundPart, hrp.CFrame)
                                        end)
                                    end
                                    local partOwner = soundPart:FindFirstChild("PartOwner")
                                    if partOwner and partOwner.Value == plr.Name then
                                        item.Name = "RB"
                                        return
                                    end
                                end
                            end
                        end
                        task.wait()
                    end
                end)

                task.wait()
                desk = inv:FindFirstChild("RB")
            end
        end

        if not desk then continue end

        -- ì¶©ëŒ ë¹„í™œì„±í™”
        pcall(function()
            for _, part in ipairs(desk:GetDescendants()) do
                if part:IsA("BasePart") then
                    part.CanCollide = false
                end
            end
        end)

        local soundPart = desk:FindFirstChild("SoundPart")
        if not soundPart then
            local destroyRemote = rs:FindFirstChild("MenuToys") and rs.MenuToys:FindFirstChild("DestroyToy")
            if destroyRemote then pcall(function() destroyRemote:FireServer(desk) end) end
            continue
        end

        local partOwner = soundPart:FindFirstChild("PartOwner")
        if not partOwner or partOwner.Value ~= plr.Name then
            local destroyRemote = rs:FindFirstChild("MenuToys") and rs.MenuToys:FindFirstChild("DestroyToy")
            if destroyRemote then pcall(function() destroyRemote:FireServer(desk) end) end
            continue
        end

        local targetFound = false

        -- ì¡ì„ ëŒ€ìƒ íƒìƒ‰
        for _, other in pairs(Players:GetPlayers()) do
            if other ~= plr and other.Character and other.Character:FindFirstChild("Head") then
                local head = other.Character.Head
                local headPartOwner = head:FindFirstChild("PartOwner")
                local FreeKick = head:FindFirstChild("OwnerKickRagdoll")

                if (headPartOwner and headPartOwner:IsA("StringValue") and headPartOwner.Value == plr.Name) or
                   (FreeKick and FreeKick:IsA("StringValue")) then

                    local humanoid = other.Character:FindFirstChildOfClass("Humanoid")
                    if humanoid then
                        local ragdolled = humanoid:FindFirstChild("Ragdolled")
                        if ragdolled and ragdolled:IsA("BoolValue") and ragdolled.Value then
                            continue
                        end
                    end

                    local otherHrp = other.Character:FindFirstChild("HumanoidRootPart")
                    if otherHrp then
                        soundPart.CFrame = CFrame.new(0, 9999, 0)
                        task.wait(0.01)
                        soundPart.CFrame = otherHrp.CFrame * CFrame.Angles(math.rad(-90), 0, 0)
                        targetFound = true
                        break
                    end
                end
            end
        end

        -- Main BodyPosition ì²˜ë¦¬
        local main = desk:FindFirstChild("Main")
        if main then
            local bp = main:FindFirstChildOfClass("BodyPosition")
            if not bp then
                bp = Instance.new("BodyPosition")
                bp.MaxForce = Vector3.new(999999, 999999, 999999)
                bp.P = 500000
                bp.D = 5000
                bp.Parent = main
            end

            if not targetFound then
                local highPos = Vector3.new(0, 9999, 0)
                bp.Position = highPos
                soundPart.CFrame = CFrame.new(highPos)
            else
                bp.Position = soundPart.Position
            end
        end
    end

    -- ë£¨í”„ ì¢…ë£Œ í›„ RB ì •ë¦¬
    local deskToRemove = inv:FindFirstChild("RB")
    if deskToRemove then
        local destroyRemote = rs:FindFirstChild("MenuToys") and rs.MenuToys:FindFirstChild("DestroyToy")
        if destroyRemote then pcall(function() destroyRemote:FireServer(deskToRemove) end) end
    end

    _G.RGB_State = "off"
end

task.spawn(RagdollGrabF)
