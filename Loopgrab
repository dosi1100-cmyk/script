-- v5.2 (Stable Blocking Spawn: Reliability Restored)
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local StarterGui = game:GetService("StarterGui")
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")

local LocalPlayer = Players.LocalPlayer

-- [설정: 사용자 정의 상수]
local PALLET_NAME = "PalletLightBrown"
local SPAM_INTERVAL = 0.001      -- 룹그랩 스팸 간격
local DROP_HEIGHT = 50000       -- 높이: 5만
local DROP_SPEED = -300000      -- 속도: 30만
local IMPACT_POWER = 10         -- 파워: 10
local SEGMENTS = 8              -- 분할: 8번

-- [리모트 찾기]
local menuToys = ReplicatedStorage:WaitForChild("MenuToys", 5)
local spawnToyRemote = menuToys and menuToys:WaitForChild("SpawnToyRemoteFunction")
local destroyToyRemote = menuToys and menuToys:FindFirstChild("DestroyToy")

local grabEvents = ReplicatedStorage:WaitForChild("GrabEvents", 5)
local setNetworkOwnerRemote = grabEvents and grabEvents:WaitForChild("SetNetworkOwner")
local destroyGrabLineRemote = grabEvents and grabEvents:WaitForChild("DestroyGrabLine")

if not (spawnToyRemote and destroyToyRemote and setNetworkOwnerRemote and destroyGrabLineRemote) then
    warn("[System] 필수 리모트를 찾지 못했습니다.")
    return
end

-- ==========================================
-- [토글 시스템]
-- ==========================================
if getgenv().LoopGrabRunning then
    -- [OFF]
    getgenv().LoopGrabRunning = false
    getgenv().CurrentGrabbedTarget = nil
    getgenv().IsRespawning = false
    
    if getgenv().LoopGrabConnection then
        getgenv().LoopGrabConnection:Disconnect()
        getgenv().LoopGrabConnection = nil
    end

    if getgenv().CurrentPalletModel and getgenv().CurrentPalletModel.Parent then
        pcall(function() 
            destroyToyRemote:FireServer(getgenv().CurrentPalletModel) 
        end)
    end
    getgenv().CurrentPalletModel = nil
    getgenv().CurrentPalletPart = nil

    StarterGui:SetCore("SendNotification", {
        Title = "System",
        Text = "Loop Grab: OFF",
        Duration = 3
    })
    return
else
    -- [ON]
    getgenv().LoopGrabRunning = true
    getgenv().IsRespawning = false
end

-- [충돌 방지 함수]
local function SetNoCollisionWithPlayer(palletPart)
    local char = LocalPlayer.Character
    if not char then return end
    for _, part in pairs(char:GetDescendants()) do
        if part:IsA("BasePart") then
            local constraint = Instance.new("NoCollisionConstraint")
            constraint.Part0 = palletPart
            constraint.Part1 = part
            constraint.Parent = palletPart
        end
    end
end

-- ==========================================
-- [핵심: 안정적 소환 (서버 응답 대기)]
-- ==========================================
local function SpawnPallet()
    if getgenv().IsRespawning or not getgenv().LoopGrabRunning then return end
    getgenv().IsRespawning = true

    -- 1. 잔여물 정리
    if getgenv().CurrentPalletModel and getgenv().CurrentPalletModel.Parent then
        pcall(function() destroyToyRemote:FireServer(getgenv().CurrentPalletModel) end)
    end
    getgenv().CurrentPalletModel = nil
    getgenv().CurrentPalletPart = nil

    local char = LocalPlayer.Character
    local hrp = char and char:FindFirstChild("HumanoidRootPart")
    
    if not hrp then 
        getgenv().IsRespawning = false 
        return 
    end

    -- 2. 좌표 계산 (머리 위 15스터드 + 시선 정렬)
    local spawnPos = hrp.Position + Vector3.new(0, 3, 0)
    local rx, ry, rz = hrp.CFrame:ToOrientation()
    local finalCFrame = CFrame.new(spawnPos) * CFrame.fromOrientation(math.rad(90), ry, 0)

    -- 3. [Blocking 소환] 서버가 응답할 때까지 여기서 대기함 (안정성 확보)
    spawnToyRemote:InvokeServer(PALLET_NAME, finalCFrame, Vector3.zero)

    -- 4. [즉시 탐색] 응답이 왔으므로 판자는 무조건 있어야 함
    local toyFolder = Workspace:WaitForChild(LocalPlayer.Name .. "SpawnedInToys", 5)
    local foundModel = nil

    if toyFolder then
        local startTime = os.clock()
        -- 혹시 모를 렉 대비 0.5초 여유 시간
        while os.clock() - startTime < 0.5 do
            if not getgenv().LoopGrabRunning then return end
            
            local children = toyFolder:GetChildren()
            for i = #children, 1, -1 do
                if children[i].Name == PALLET_NAME and children[i]:IsA("Model") then
                    foundModel = children[i]
                    break
                end
            end
            
            if foundModel then break end
            task.wait()
        end
    end

    -- 5. [획득]
    if foundModel then
        local foundPart = foundModel:FindFirstChild("SoundPart") or foundModel:WaitForChild("SoundPart", 1)
        
        if foundPart then
            getgenv().CurrentPalletModel = foundModel
            getgenv().CurrentPalletPart = foundPart
            
            SetNoCollisionWithPlayer(foundPart)
            foundPart.CanCollide = false
            
            -- [버스트] 0.1초간 소유권 전송
            for i = 1, 5 do
                if not foundPart.Parent then break end
                pcall(function()
                    setNetworkOwnerRemote:FireServer(foundPart, foundPart.CFrame)
                end)
                task.wait(0.02)
            end
            
            foundPart.CFrame = CFrame.new(0, DROP_HEIGHT, 0)
        end
    end

    getgenv().IsRespawning = false
end

-- 초기 실행
task.spawn(SpawnPallet)

-- ==========================================
-- [Part 2: 훅 (타겟 유지)]
-- ==========================================
if not getgenv().LoopGrabHookInstalled then
    getgenv().LoopGrabHookInstalled = true
    local oldNamecall
    oldNamecall = hookmetamethod(game, "__namecall", function(self, ...)
        if not getgenv().LoopGrabRunning then
            return oldNamecall(self, ...)
        end

        local method = getnamecallmethod()
        if method == "FireServer" then
            if self == setNetworkOwnerRemote then
                if not checkcaller() then
                    local targetPart = ({...})[1]
                    if targetPart ~= getgenv().CurrentPalletPart and targetPart:IsA("BasePart") then
                        getgenv().CurrentGrabbedTarget = targetPart
                    end
                end
            elseif self == destroyGrabLineRemote then
                if not checkcaller() then
                    getgenv().CurrentGrabbedTarget = nil
                end
            end
        end
        return oldNamecall(self, ...)
    end)
end

-- ==========================================
-- [Part 3: 무한 루프]
-- ==========================================
local hammerGoingDown = true
local segmentIndex = 0
local lastSpamTime = 0

getgenv().LoopGrabConnection = RunService.Heartbeat:Connect(function()
    if not getgenv().LoopGrabRunning then return end

    local now = os.clock()
    local grabbedTarget = getgenv().CurrentGrabbedTarget
    local palletPart = getgenv().CurrentPalletPart
    local palletModel = getgenv().CurrentPalletModel

    -- [A] 룹그랩 유지
    if grabbedTarget and grabbedTarget.Parent then
        if now - lastSpamTime >= SPAM_INTERVAL then
            pcall(function()
                setNetworkOwnerRemote:FireServer(grabbedTarget, grabbedTarget.CFrame)
            end)
            lastSpamTime = now
        end
    end

    -- [B] 판자 로직
    if palletModel and palletModel.Parent and palletPart and palletPart.Parent then
        local targetHrp = nil
        if grabbedTarget and grabbedTarget.Parent then
            local model = grabbedTarget.Parent
            if model:FindFirstChild("Humanoid") then
                targetHrp = model:FindFirstChild("HumanoidRootPart") or model:FindFirstChild("Torso")
            end
        end

        if targetHrp then
            local startPos = targetHrp.Position + Vector3.new(0, DROP_HEIGHT, 0)
            local endPos = targetHrp.Position

            if hammerGoingDown then
                segmentIndex = segmentIndex + 1
                local alpha = segmentIndex / SEGMENTS
                local nextPos = startPos:Lerp(endPos, alpha)
                
                palletPart.CFrame = CFrame.new(nextPos)
                palletPart.AssemblyLinearVelocity = Vector3.new(0, DROP_SPEED, 0)
                palletPart.AssemblyAngularVelocity = Vector3.zero
                
                if segmentIndex >= SEGMENTS then
                    palletPart.AssemblyLinearVelocity = Vector3.new(0, -IMPACT_POWER, 0)
                    hammerGoingDown = false
                end
            else
                palletPart.CFrame = CFrame.new(startPos)
                palletPart.AssemblyLinearVelocity = Vector3.zero
                segmentIndex = 0
                hammerGoingDown = true
            end
        else
            palletPart.CFrame = CFrame.new(0, DROP_HEIGHT, 0)
            palletPart.AssemblyLinearVelocity = Vector3.zero
            palletPart.AssemblyAngularVelocity = Vector3.zero
            segmentIndex = 0
            hammerGoingDown = true
        end
    else
        -- [C] 판자 없을 시 즉시 재생성
        if not getgenv().IsRespawning then
            SpawnPallet()
        end
    end
end)

StarterGui:SetCore("SendNotification", {
    Title = "System",
    Text = "Loop Grab v5.2 (Stable): ON",
    Duration = 3
})
