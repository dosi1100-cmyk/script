-- v5.7
local StarterGui = game:GetService("StarterGui")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")

local LocalPlayer = Players.LocalPlayer

-- ==========================================
-- [중복 실행 방지 (Already Running Check)]
-- ==========================================
if getgenv().LoopGrabRunning then
    warn("[System] Loop Grab is already running!")
    StarterGui:SetCore("SendNotification", {
        Title = "System",
        Text = "이미 룹그랩이 켜져 있습니다!",
        Duration = 3
    })
    return -- 이미 켜져있으면 여기서 스크립트 종료
end

-- ==========================================
-- [0. 실행기 호환성 테스트]
-- ==========================================
local requiredFunctions = {
    "getgenv",
    "hookmetamethod",
    "checkcaller",
    "getnamecallmethod"
}

for _, funcName in ipairs(requiredFunctions) do
    if not getfenv()[funcName] then
        warn("[System] 호환성 테스트 실패! 없는 함수: " .. funcName)
        StarterGui:SetCore("SendNotification", {
            Title = "System Error",
            Text = "이 실행기는 스크립트를 지원하지 않습니다.",
            Duration = 5,
        })
        return
    end
end

-- [상태 활성화]
getgenv().LoopGrabRunning = true

-- ==========================================
-- [설정 및 변수]
-- ==========================================
local SPAM_INTERVAL = 0.018

-- [리모트 찾기]
local grabEvents = ReplicatedStorage:WaitForChild("GrabEvents", 5)
local setNetworkOwnerRemote = grabEvents and grabEvents:WaitForChild("SetNetworkOwner")
local destroyGrabLineRemote = grabEvents and grabEvents:WaitForChild("DestroyGrabLine")

if not (setNetworkOwnerRemote and destroyGrabLineRemote) then
    warn("[System] 필수 리모트를 찾지 못했습니다.")
    -- 리모트 못 찾으면 실행 상태 다시 끔
    getgenv().LoopGrabRunning = false
    return
end

-- ==========================================
-- [훅 시스템]
-- ==========================================
if not getgenv().LoopGrabHookInstalled then
    getgenv().LoopGrabHookInstalled = true
    local oldNamecall
    oldNamecall = hookmetamethod(game, "__namecall", function(self, ...)
        if not getgenv().LoopGrabRunning then
            return oldNamecall(self, ...)
        end

        local method = getnamecallmethod()
        if method == "FireServer" then
            if self == setNetworkOwnerRemote then
                if not checkcaller() then
                    local targetPart = ({...})[1]
                    if targetPart:IsA("BasePart") then
                        getgenv().CurrentGrabbedTarget = targetPart
                    end
                end
            elseif self == destroyGrabLineRemote then
                if not checkcaller() then
                    getgenv().CurrentGrabbedTarget = nil
                end
            end
        end
        return oldNamecall(self, ...)
    end)
end

-- ==========================================
-- [무한 루프 시작]
-- ==========================================
local lastSpamTime = 0

getgenv().LoopGrabConnection = RunService.Heartbeat:Connect(function()
    if not getgenv().LoopGrabRunning then return end

    local now = os.clock()
    local grabbedTarget = getgenv().CurrentGrabbedTarget

    -- [A] 룹그랩 유지
    if grabbedTarget and grabbedTarget.Parent then
        if now - lastSpamTime >= SPAM_INTERVAL then
            pcall(function()
                setNetworkOwnerRemote:FireServer(grabbedTarget, grabbedTarget.CFrame)
            end)
            lastSpamTime = now
        end
    end
end)

StarterGui:SetCore("SendNotification", {
    Title = "System",
    Text = "Loop Grab v5.7 : ON",
    Duration = 3
})

local StarterGui = game:GetService("StarterGui")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

if getgenv().PalletAttackRunning then
    getgenv().PalletAttackRunning = false
            
    if getgenv().PalletAttackConnection then
        getgenv().PalletAttackConnection:Disconnect()
        getgenv().PalletAttackConnection = nil
    end
            
    if getgenv().CurrentPalletModel and getgenv().CurrentPalletModel.Parent then
        local menuToys = ReplicatedStorage:FindFirstChild("MenuToys")
        local destroyToyRemote = menuToys and menuToys:FindFirstChild("DestroyToy")
        if destroyToyRemote then
            pcall(function() destroyToyRemote:FireServer(getgenv().CurrentPalletModel) end)
        end
    end
            
    getgenv().CurrentPalletModel = nil
    getgenv().CurrentPalletPart = nil
    getgenv().PalletAttackTarget = nil
