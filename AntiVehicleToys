if getgenv().AntiVehicleToyEnabled then
    game:GetService("StarterGui"):SetCore("SendNotification", {
        Title = "Anti-Vehicle Toy";
        Text = "Already Enabled (이미 켜져있음)";
        Duration = 3;
    })
    return
end

getgenv().AntiVehicleToyEnabled = true
game:GetService("StarterGui"):SetCore("SendNotification", {
    Title = "Anti-Vehicle Toy";
    Text = "Enabled (켜짐)";
    Duration = 3;
})

local Players = game:GetService("Players")
local plr = Players.LocalPlayer
local workspace = game:GetService("Workspace")

local Whitelist = {} 
local WhiteListMode = false 

task.spawn(function()
    local FallenY = workspace.FallenPartsDestroyHeight
    local targetY = (FallenY <= -50000 and -49999) or (FallenY <= -100 and -99) or -100
    local dropPos = CFrame.new(0, targetY, 9999)
    local targetItems = {"CreatureBlobman", "TractorRed", "TractorOrange", "TractorGreen", "SantaSleigh"}

    local processedBlobs = {}
    local cleanupInterval = 2

    while getgenv().AntiVehicleToyEnabled do
        task.wait(0.1)

        local char = plr.Character
        local root = char and char:FindFirstChild("HumanoidRootPart")
        local hum = char and char:FindFirstChildOfClass("Humanoid")

        if not char or not root or not hum then continue end

        local myPlotNumber = nil
        local plots = workspace:FindFirstChild("Plots")
        if plots then
            for i = 1, 5 do
                local plot = plots:FindFirstChild("Plot" .. i)
                local plotSign = plot and plot:FindFirstChild("PlotSign")
                local owners = plotSign and plotSign:FindFirstChild("ThisPlotsOwners")
                local ownerVal = owners and owners:FindFirstChildOfClass("StringValue")
                if ownerVal and ownerVal.Value == plr.Name then
                    myPlotNumber = i
                    break
                end
            end
        end

        local function collectItemsFromFolder(folder)
            local items = {}
            for _, item in ipairs(folder:GetChildren()) do
                if item:IsA("Model") and table.find(targetItems, item.Name) then
                    if item:FindFirstChild("VehicleSeat") then
                        local vs = item:FindFirstChildOfClass("VehicleSeat")
                        if vs and vs.Occupant then 
                            if vs.Occupant == hum then
                                table.insert(items, item)
                            end
                            continue 
                        end

                        local itemId = tostring(item:GetDebugId())
                        if not processedBlobs[itemId] then
                            table.insert(items, item)
                        end
                    end
                end
            end
            return items
        end

        local allItems = {}
        for _, player in ipairs(Players:GetPlayers()) do
            if player == plr then continue end
            if WhiteListMode then
                local inWhitelist = false
                for _, whiteName in ipairs(Whitelist) do 
                    if player.Name == whiteName then 
                        inWhitelist = true 
                        break 
                    end 
                end
                if inWhitelist then continue end
            end
            local folder = workspace:FindFirstChild(player.Name .. "SpawnedInToys")
            if folder then 
                for _, item in ipairs(collectItemsFromFolder(folder)) do 
                    table.insert(allItems, item) 
                end 
            end
        end

        local plotItems = workspace:FindFirstChild("PlotItems")
        if plotItems then
            for i = 1, 5 do
                if i == myPlotNumber then continue end
                local plot = plotItems:FindFirstChild("Plot" .. i)
                if plot then 
                    for _, item in ipairs(collectItemsFromFolder(plot)) do 
                        table.insert(allItems, item) 
                    end 
                end
            end
        end

        for _, item in ipairs(allItems) do
            if not getgenv().AntiVehicleToyEnabled then break end

            local itemId = tostring(item:GetDebugId())

            if processedBlobs[itemId] then
                continue
            end

            local char = plr.Character
            local root = char and char:FindFirstChild("HumanoidRootPart")
            local hum = char and char:FindFirstChildOfClass("Humanoid")

            if not char or not root or not hum then break end

            local vs = item:FindFirstChildOfClass("VehicleSeat")

            if vs then
                if vs.Occupant and vs.Occupant ~= hum then 
                    continue 
                end

                root.Anchored = true
                vs:Sit(hum)

                if hum and vs then
                    task.wait(0.15)
                    hum:ChangeState(Enum.HumanoidStateType.Running)
                    task.wait()
                    if item.PrimaryPart then item:SetPrimaryPartCFrame(dropPos) end
                    
                    root.Anchored = true
                    task.wait(0.03)
                    root.Anchored = false

                    if root and vs then
                        local connection
                        connection = vs.AncestryChanged:Connect(function()
                            if not vs or not vs.Parent then
                                if connection then
                                    connection:Disconnect()
                                end
                                processedBlobs[itemId] = true

                                task.delay(cleanupInterval, function()
                                    processedBlobs[itemId] = nil
                                end)
                            end
                        end)

                        task.delay(2, function()
                            if connection then
                                connection:Disconnect()
                            end
                            processedBlobs[itemId] = true

                            task.delay(cleanupInterval, function()
                                processedBlobs[itemId] = nil
                            end)
                        end)
                    end
                end

                task.wait(0.01)
            end

            break
        end
    end
end)
