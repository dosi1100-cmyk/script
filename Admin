-- Version: v9.6
local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local StarterGui = game:GetService("StarterGui")
local RunService = game:GetService("RunService")
local MarketplaceService = game:GetService("MarketplaceService")
local Lighting = game:GetService("Lighting")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local HttpService = game:GetService("HttpService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TextChatService = game:GetService("TextChatService")
local VirtualUser = game:GetService("VirtualUser")
local Workspace = game:GetService("Workspace")
local Terrain = Workspace:FindFirstChildOfClass("Terrain")
local Stats = game:GetService("Stats")
local lp = Players.LocalPlayer
local CoreGui = game:GetService("CoreGui")

-- [카메라 원본 설정 저장 (종료 시 복구용)]
local defaultCameraMode = lp.CameraMode
local defaultMinZoom = lp.CameraMinZoomDistance
local defaultMaxZoom = lp.CameraMaxZoomDistance
local defaultFOV = workspace.CurrentCamera.FieldOfView

local chatConnection
local mainInputConnection
local startTime = tick()
local serverInfoGui

local customSpawnCFrame = nil
local spawnConnection = nil
local fullbrightLoop = nil 
local savedLightingSettings = {} 

-- [FPS 부스트 관련 변수 저장용]
local fpsBoostEnabled = false
local fpsBoostConnection = nil
local originalLightingState = {} 
local cachedParts = {}

-- [Anti-AFK 관련 변수]
local antiAfkEnabled = false
local antiAfkConnection = nil

-- [Anti-Lag 관련 변수]
local antiLagEnabled = true 
local antiLagLoop = nil

-- [DelLines (CharacterAndBeamMove) 관련 변수]
local delLinesEnabled = false

-- [WalkFling 관련 변수]
local walkflingEnabled = false

-- [Noclip 관련 변수]
local noclipConnection = nil

-- [Spin 관련 변수]
local spinEnabled = false
local spinSpeed = 10
local spinConnection = nil

-- [Fly 및 VFly 관련 변수]
local flyConnection = nil
local currentFlyType = nil
local flySpeed = 50
local flyObjects = {} 

-- [무한점프 관련 변수]
local infJumpConnection = nil
local previousJumpPower = nil

-- [Speed & JumpPower Loop 관련 변수]
local loopSpeedConnection = nil
local loopJumpConnection = nil
local targetWalkSpeed = 16
local targetJumpPower = 50

-- [tpwalk 관련 변수]
local tpwalkEnabled = false
local tpwalkStep = 1
local tpwalkConnection = nil

-- [IconESP 관련 변수]
local iconEspEnabled = false
local iconEspConnection = nil
local iconEspMaxDist = 1000 

-- [PLCD 관련 변수]
local plcdEnabled = false
local plcdConnection = nil

-- [PLCD 삭제 (Auto Reset) 관련 변수]
local autoResetEnabled = false
local autoResetPending = false
local autoResetForced = false 
local autoResetDiedConnection = nil
local autoResetCharConnection = nil

-- [음식 뺏어가기(TakeFood) 관련 변수]
local takeFoodEnabled = false
local takeFoodConnections = {}
local takeFoodTargets = {}

-- [Anti-Bomb 관련 변수]
local antiBombEnabled = false
local currentOven = nil

-- [AntiInPlots 관련 변수]
local antiInPlotsEnabled = false

-- [친구 목록 GUI 관련 변수]
local friendListGui = nil
local friendListContent = nil
local friendListTitle = nil
local friendListLayout = nil

-- [친구 상태 캐시]
local friendCache = {}

-- [명령 입력 포커스 상태]
local cmdFocused = false

-- [관전 관련 변수 추가]
local viewingPlayer = nil
local viewConnection = nil

-- Executor별 HTTP Request 호환성 처리 (Server Hop 등에서 사용됨)
local http_request = (syn and syn.request) or (http and http.request) or http_request or (fluxus and fluxus.request) or request

-- [친구 알림용 GUI 컨테이너]
local friendAlertGui = Instance.new("ScreenGui")
friendAlertGui.Name = "FriendAlerts"
friendAlertGui.Parent = lp:WaitForChild("PlayerGui")
friendAlertGui.ResetOnSpawn = false
friendAlertGui.DisplayOrder = 999999999

local activeAlerts = {}

-- [드래그 기능 함수]
local function makeDraggable(frame)
    local dragging = false
    local dragInput
    local dragStart
    local startPos

    local function update(input)
        local delta = input.Position - dragStart
        frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end

    frame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = frame.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then dragging = false end
            end)
        end
    end)

    frame.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)

    RunService.RenderStepped:Connect(function()
        if dragging and dragInput then update(dragInput) end
    end)
end

-- ==========================================
-- [친구 목록 GUI 기능]
-- ==========================================
local function updateFriendList()
    if not friendListGui or not friendListGui.Enabled then return end
    if not friendListContent then return end

    for _, child in pairs(friendListContent:GetChildren()) do
        if child:IsA("TextLabel") then child:Destroy() end
    end

    local index = 1
    local friendCount = 0

    for _, p in pairs(Players:GetPlayers()) do
        if p ~= lp and lp:IsFriendsWith(p.UserId) then
            friendCount = friendCount + 1
            local lbl = Instance.new("TextLabel")
            lbl.Name = "FriendEntry"
            lbl.Size = UDim2.new(1, -10, 0, 25)
            lbl.BackgroundTransparency = 1
            lbl.TextColor3 = Color3.fromRGB(230, 230, 230)
            lbl.TextXAlignment = Enum.TextXAlignment.Left
            lbl.Font = Enum.Font.GothamSemibold
            lbl.TextSize = 14
            lbl.Text = tostring(index) .. ". " .. p.DisplayName .. " (@" .. p.Name .. ")"
            lbl.Parent = friendListContent
            index = index + 1
        end
    end

    if friendCount == 0 then
        local lbl = Instance.new("TextLabel")
        lbl.Name = "NoFriendEntry"
        lbl.Size = UDim2.new(1, -10, 0, 25)
        lbl.BackgroundTransparency = 1
        lbl.TextColor3 = Color3.fromRGB(150, 150, 150)
        lbl.TextXAlignment = Enum.TextXAlignment.Center
        lbl.Font = Enum.Font.Gotham
        lbl.TextSize = 14
        lbl.Text = "현재 접속중인 친구가 없습니다."
        lbl.Parent = friendListContent
    end

    if friendListLayout then
        task.delay(0.05, function()
            local contentHeight = friendListLayout.AbsoluteContentSize.Y
            friendListContent.CanvasSize = UDim2.new(0, 0, 0, contentHeight + 10)
        end)
    end
end

local function createFriendListGui()
    if friendListGui then return end
    local sg = Instance.new("ScreenGui")
    sg.Name = "FriendListGui"
    sg.Parent = lp:WaitForChild("PlayerGui")
    sg.ResetOnSpawn = false
    sg.DisplayOrder = 999999996

    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(0, 250, 0, 300)
    frame.Position = UDim2.new(0, 20, 0.5, -150) 
    frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    frame.BorderSizePixel = 0
    frame.Parent = sg
    makeDraggable(frame)
    local corner = Instance.new("UICorner"); corner.CornerRadius = UDim.new(0, 10); corner.Parent = frame

    local title = Instance.new("TextLabel")
    title.Size = UDim2.new(1, -40, 0, 40)
    title.BackgroundTransparency = 1
    title.Text = "친구 목록"
    title.Font = Enum.Font.GothamBold
    title.TextSize = 18
    title.TextColor3 = Color3.new(1, 1, 1)
    title.Parent = frame
    friendListTitle = title

    local closeBtn = Instance.new("TextButton")
    closeBtn.Size = UDim2.new(0, 30, 0, 30)
    closeBtn.Position = UDim2.new(1, -35, 0, 5)
    closeBtn.Text = "X"
    closeBtn.TextColor3 = Color3.new(1, 1, 1)
    closeBtn.BackgroundColor3 = Color3.fromRGB(220, 60, 60)
    closeBtn.Font = Enum.Font.GothamBold
    closeBtn.Parent = frame
    local btnCorner = Instance.new("UICorner"); btnCorner.CornerRadius = UDim.new(0, 5); btnCorner.Parent = closeBtn
    closeBtn.MouseButton1Click:Connect(function() sg.Enabled = false end)

    local scroll = Instance.new("ScrollingFrame")
    scroll.Name = "FriendScroll"
    scroll.Size = UDim2.new(1, -20, 1, -50)
    scroll.Position = UDim2.new(0, 10, 0, 45)
    scroll.BackgroundTransparency = 1
    scroll.BorderSizePixel = 0
    scroll.ScrollBarThickness = 6
    scroll.AutomaticCanvasSize = Enum.AutomaticSize.Y
    scroll.CanvasSize = UDim2.new(0, 0, 0, 0)
    scroll.Parent = frame

    local layout = Instance.new("UIListLayout")
    layout.Parent = scroll
    layout.SortOrder = Enum.SortOrder.LayoutOrder
    layout.Padding = UDim.new(0, 5)
    layout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
        local contentHeight = layout.AbsoluteContentSize.Y
        scroll.CanvasSize = UDim2.new(0, 0, 0, contentHeight + 10)
    end)
    friendListLayout = layout
    friendListContent = scroll
    friendListGui = sg
    friendListGui = sg
    updateFriendList()
end

local function toggleFriendList()
    if not friendListGui then createFriendListGui()
    else
        friendListGui.Enabled = not friendListGui.Enabled
        if friendListGui.Enabled then updateFriendList() end
    end
end

-- [Anti-AFK 함수 구현]
local function toggleAntiAfk(state)
    if state then
        if antiAfkEnabled then return end
        antiAfkEnabled = true
        
        antiAfkConnection = lp.Idled:Connect(function()
            VirtualUser:CaptureController()
            VirtualUser:ClickButton2(Vector2.new())
        end)
        
        StarterGui:SetCore("SendNotification", {Title = "Anti-AFK 켜짐", Text = "20분 잠수 킥을 방지합니다.", Duration = 3})
    else
        antiAfkEnabled = false
        if antiAfkConnection then
            antiAfkConnection:Disconnect()
            antiAfkConnection = nil
        end
        StarterGui:SetCore("SendNotification", {Title = "Anti-AFK 꺼짐", Text = "이제 잠수하면 튕길 수 있습니다.", Duration = 3})
    end
end

if game.PlaceId == 6961824067 then
    loadstring(game:HttpGet('https://raw.githubusercontent.com/dosi1100-cmyk/script/refs/heads/main/kickalarm'))()
end

local function toggleAntiLag(enable)
    if enable then
        if antiLagLoop then return end
        antiLagEnabled = true
        antiLagLoop = task.spawn(function()
            while antiLagEnabled do
                task.wait(0.3) 
                local fps = workspace:GetRealPhysicsFPS()
                local kbps = Stats.DataReceiveKbps
                
                if fps < 8 or kbps > 2000 then
                    game:Shutdown()
                    break
                end
            end
        end)
    else
        antiLagEnabled = false
        if antiLagLoop then 
            task.cancel(antiLagLoop) 
            antiLagLoop = nil 
        end
    end
end

-- [DelLines 함수]
local function toggleDelLines(state)
    local playerScripts = lp:FindFirstChild("PlayerScripts")
    if not playerScripts then return end

    local targetScript = playerScripts:FindFirstChild("CharacterAndBeamMove")
    
    if targetScript then
        if state then
            if not targetScript.Disabled then
                targetScript.Disabled = true
                delLinesEnabled = true
                StarterGui:SetCore("SendNotification", {Title = "DelLines 켜짐", Text = "CharacterAndBeamMove 스크립트가 비활성화되었습니다.", Duration = 3})
            else
                StarterGui:SetCore("SendNotification", {Title = "DelLines", Text = "이미 비활성화 되어있습니다.", Duration = 2})
            end
        else
            if targetScript.Disabled then
                targetScript.Disabled = false
                delLinesEnabled = false
                StarterGui:SetCore("SendNotification", {Title = "DelLines 꺼짐", Text = "CharacterAndBeamMove 스크립트가 다시 활성화되었습니다.", Duration = 3})
            else
                StarterGui:SetCore("SendNotification", {Title = "DelLines", Text = "이미 활성화 되어있습니다.", Duration = 2})
            end
        end
    else
        StarterGui:SetCore("SendNotification", {Title = "오류", Text = "CharacterAndBeamMove 스크립트를 찾을 수 없습니다.", Duration = 3})
    end
end

-- [FPS 부스트 및 복구 함수]
local function toggleFpsBoost(enable)
    if enable then
        if fpsBoostEnabled then return end
        fpsBoostEnabled = true

        originalLightingState = {
            GlobalShadows = Lighting.GlobalShadows,
            FogEnd = Lighting.FogEnd,
            Brightness = Lighting.Brightness,
            OutdoorAmbient = Lighting.OutdoorAmbient,
            Ambient = Lighting.Ambient
        }

        Lighting.GlobalShadows = false
        Lighting.FogEnd = 9e9
        Lighting.Brightness = 1

        if Terrain then
            Terrain.WaterWaveSize = 0
            Terrain.WaterWaveSpeed = 0
            Terrain.WaterReflectance = 0
            Terrain.WaterTransparency = 0
        end

        local function optimizeObject(v)
            if v:IsA("BasePart") and not v:IsA("Terrain") then
                if not cachedParts[v] then
                    cachedParts[v] = {
                        Type = "BasePart",
                        Material = v.Material,
                        Reflectance = v.Reflectance,
                        CastShadow = v.CastShadow
                    }
                end
                v.Material = Enum.Material.SmoothPlastic
                v.Reflectance = 0
                v.CastShadow = false

            elseif v:IsA("Decal") or v:IsA("Texture") then
                if not cachedParts[v] then
                    cachedParts[v] = {
                        Type = "Texture",
                        Transparency = v.Transparency
                    }
                end
                v.Transparency = 1 

            elseif v:IsA("ParticleEmitter") or v:IsA("Trail") or v:IsA("Smoke") or v:IsA("Fire") or v:IsA("Sparkles") then
                if not cachedParts[v] then
                    cachedParts[v] = {
                        Type = "Effect",
                        Enabled = v.Enabled
                    }
                end
                v.Enabled = false

            elseif v:IsA("MeshPart") then
                if not cachedParts[v] then
                    cachedParts[v] = {
                        Type = "MeshPart",
                        Material = v.Material
                    }
                end
                v.Material = Enum.Material.SmoothPlastic
            end
        end

        for _, v in pairs(Workspace:GetDescendants()) do
            pcall(function() optimizeObject(v) end)
        end

        fpsBoostConnection = Workspace.DescendantAdded:Connect(function(v)
            pcall(function() optimizeObject(v) end)
        end)

        StarterGui:SetCore("SendNotification", {Title = "FPS 부스트 켜짐", Text = "그래픽을 낮추고 원본 설정을 저장했습니다.", Duration = 3})

    else
        if not fpsBoostEnabled then return end
        fpsBoostEnabled = false

        if fpsBoostConnection then
            fpsBoostConnection:Disconnect()
            fpsBoostConnection = nil
        end

        if originalLightingState.GlobalShadows ~= nil then
            Lighting.GlobalShadows = originalLightingState.GlobalShadows
            Lighting.FogEnd = originalLightingState.FogEnd
            Lighting.Brightness = originalLightingState.Brightness
            Lighting.OutdoorAmbient = originalLightingState.OutdoorAmbient
            Lighting.Ambient = originalLightingState.Ambient
        else
            Lighting.GlobalShadows = true
            Lighting.FogEnd = 10000
            Lighting.Brightness = 2
        end

        for obj, data in pairs(cachedParts) do
            if obj and obj.Parent then
                pcall(function()
                    if data.Type == "BasePart" then
                        obj.Material = data.Material
                        obj.Reflectance = data.Reflectance
                        obj.CastShadow = data.CastShadow
                    elseif data.Type == "Texture" then
                        obj.Transparency = data.Transparency
                    elseif data.Type == "Effect" then
                        obj.Enabled = data.Enabled
                    elseif data.Type == "MeshPart" then
                        obj.Material = data.Material
                    end
                end)
            end
        end

        cachedParts = {}
        StarterGui:SetCore("SendNotification", {Title = "FPS 부스트 꺼짐", Text = "원래 그래픽 및 재질로 복구되었습니다.", Duration = 3})
    end
end

-- [채팅 함수]
local function sendChatMessage(msg)
    if not msg or #msg == 0 then return end
    local legacyChat = ReplicatedStorage:FindFirstChild("DefaultChatSystemChatEvents")
    if legacyChat and legacyChat:FindFirstChild("SayMessageRequest") then
        legacyChat.SayMessageRequest:FireServer(msg, "All")
    elseif TextChatService.ChatVersion == Enum.ChatVersion.TextChatService then
        local channel = TextChatService:FindFirstChild("TextChannels") and TextChatService.TextChannels:FindFirstChild("RBXGeneral")
        if channel then channel:SendAsync(msg) end
    else
        pcall(function() Players:Chat(msg) end)
    end
end

-- [IconESP 기능]
local function removeAllIconEsp()
    for _, p in pairs(Players:GetPlayers()) do
        if p.Character then
            local head = p.Character:FindFirstChild("Head")
            if head then
                local oldGui = head:FindFirstChild("IconESP_Billboard")
                if oldGui then oldGui:Destroy() end
            end
        end
    end
end

local function toggleIconEsp(state)
    iconEspEnabled = state
    if state then
        if iconEspConnection then iconEspConnection:Disconnect() end
        iconEspConnection = RunService.RenderStepped:Connect(function()
            if not iconEspEnabled then return end
            local myChar = lp.Character
            local myRoot = myChar and myChar:FindFirstChild("HumanoidRootPart")
            if not myRoot then return end
            for _, p in pairs(Players:GetPlayers()) do
                if p ~= lp and p.Character then
                    local head = p.Character:FindFirstChild("Head")
                    local root = p.Character:FindFirstChild("HumanoidRootPart")
                    if head and root then
                        local dist = (myRoot.Position - root.Position).Magnitude
                        local bg = head:FindFirstChild("IconESP_Billboard")
                        if not bg then
                            bg = Instance.new("BillboardGui")
                            bg.Name = "IconESP_Billboard"
                            bg.Adornee = head
                            bg.Size = UDim2.new(0, 100, 0, 100)
                            bg.StudsOffset = Vector3.new(0, 3, 0)
                            bg.AlwaysOnTop = true
                            bg.Parent = head
                            local img = Instance.new("ImageLabel")
                            img.Size = UDim2.new(0, 60, 0, 60)
                            img.Position = UDim2.new(0.5, -30, 0, 0)
                            img.BackgroundTransparency = 1
                            img.Parent = bg
                            task.spawn(function()
                                local content, isReady = Players:GetUserThumbnailAsync(p.UserId, Enum.ThumbnailType.HeadShot, Enum.ThumbnailSize.Size420x420)
                                if isReady then
                                    img.Image = content
                                    local corner = Instance.new("UICorner"); corner.CornerRadius = UDim.new(1, 0); corner.Parent = img
                                end
                            end)
                            local txt = Instance.new("TextLabel")
                            txt.Size = UDim2.new(1, 0, 0, 20)
                            txt.Position = UDim2.new(0, 0, 0, 65)
                            txt.BackgroundTransparency = 1
                            txt.Text = p.DisplayName .. "\n(@"..p.Name..")"
                            txt.TextColor3 = Color3.new(1,1,1)
                            txt.TextStrokeTransparency = 0
                            txt.Font = Enum.Font.GothamBold
                            txt.TextSize = 14
                            txt.Parent = bg
                        end
                        if dist <= iconEspMaxDist then bg.Enabled = true else bg.Enabled = false end
                    end
                end
            end
        end)
        StarterGui:SetCore("SendNotification", {Title = "IconESP 켜짐", Text = "1000 Studs 이내 플레이어 표시", Duration = 3})
    else
        if iconEspConnection then iconEspConnection:Disconnect() iconEspConnection = nil end
        removeAllIconEsp()
        StarterGui:SetCore("SendNotification", {Title = "IconESP 꺼짐", Text = "모든 ESP를 제거했습니다.", Duration = 2})
    end
end

-- [PLCD 하이라이트 기능]
local function togglePlcd(state)
    if state then
        plcdEnabled = true
        
        local function highlight(v)
            if v:IsA("BasePart") and v.Name == "PlayerCharacterLocationDetector" then
                if v:FindFirstChild("PLCD_Highlight") then return end
                
                local box = Instance.new("SelectionBox")
                box.Name = "PLCD_Highlight"
                box.Adornee = v
                box.Color3 = Color3.fromRGB(255, 0, 0) 
                box.LineThickness = 0.03 
                box.SurfaceTransparency = 1 
                box.Transparency = 0 
                box.Parent = v
            end
        end

        for _, v in pairs(Workspace:GetDescendants()) do
            highlight(v)
        end

        if plcdConnection then plcdConnection:Disconnect() end
        plcdConnection = Workspace.DescendantAdded:Connect(highlight)
        
        StarterGui:SetCore("SendNotification", {Title = "PLCD 표시", Text = "감지기 파트가 빨간 테두리로 표시됩니다 (벽 뒤 숨김).", Duration = 3})
    else
        plcdEnabled = false
        if plcdConnection then 
            plcdConnection:Disconnect() 
            plcdConnection = nil 
        end
        
        for _, v in pairs(Workspace:GetDescendants()) do
            if v.Name == "PlayerCharacterLocationDetector" then
                local box = v:FindFirstChild("PLCD_Highlight")
                if box then box:Destroy() end
            end
        end
        
        StarterGui:SetCore("SendNotification", {Title = "PLCD 해제", Text = "표시를 제거했습니다.", Duration = 3})
    end
end

-- [PLCD 삭제(Auto Reset) 로직 구현]
local function onAutoResetCharacterAdded(char)
    if not autoResetEnabled then return end
    local hum = char:WaitForChild("Humanoid", 10)
    if not hum then return end

    if autoResetPending then
        autoResetPending = false
        autoResetForced = true
        task.wait()
        if hum and hum.Health > 0 then
            hum.Health = 0 
        end
    end

    if autoResetDiedConnection then autoResetDiedConnection:Disconnect() end
    autoResetDiedConnection = hum.Died:Connect(function()
        if not autoResetEnabled then return end
        if autoResetForced then
            autoResetForced = false
        else
            autoResetPending = true
        end
    end)
end

local function toggleAutoReset(state)
    if state then
        if autoResetEnabled then return end
        autoResetEnabled = true
        
        if autoResetCharConnection then autoResetCharConnection:Disconnect() end
        autoResetCharConnection = lp.CharacterAdded:Connect(onAutoResetCharacterAdded)

        if lp.Character then
             onAutoResetCharacterAdded(lp.Character)
             local hum = lp.Character:FindFirstChild("Humanoid")
             if hum and hum.Health > 0 then
                 hum.Health = 0
             end
        end
        StarterGui:SetCore("SendNotification", {Title = "PLCD 삭제(AutoReset)", Text = "활성화됨: 부활 시 자동 재설정됩니다.", Duration = 3})
    else
        autoResetEnabled = false
        autoResetPending = false
        autoResetForced = false
        if autoResetDiedConnection then autoResetDiedConnection:Disconnect() autoResetDiedConnection = nil end
        if autoResetCharConnection then autoResetCharConnection:Disconnect() autoResetCharConnection = nil end
        StarterGui:SetCore("SendNotification", {Title = "PLCD 삭제 해제", Text = "비활성화되었습니다.", Duration = 3})
    end
end


-- [Noclip]
local function toggleNoclip(state)
    if state then
        if noclipConnection then noclipConnection:Disconnect() end
        noclipConnection = RunService.Stepped:Connect(function()
            if lp.Character then
                for _, v in pairs(lp.Character:GetDescendants()) do
                    if v:IsA("BasePart") and v.CanCollide then v.CanCollide = false end
                end
            end
        end)
    else
        if noclipConnection then noclipConnection:Disconnect() noclipConnection = nil end
    end
end

-- [Spin 기능]
local function toggleSpin(state, speed)
    if state then
        if spinEnabled then
            StarterGui:SetCore("SendNotification", {Title = "Spin", Text = "이미 실행 중입니다.", Duration = 2})
            return
        end
        
        spinSpeed = tonumber(speed) or 10
        if spinSpeed <= 0 then spinSpeed = 10 end
        spinEnabled = true
        
        if spinConnection then spinConnection:Disconnect() end
        spinConnection = RunService.Heartbeat:Connect(function()
            if not spinEnabled then return end
            local char = lp.Character
            if not char then return end
            local hrp = char:FindFirstChild("HumanoidRootPart")
            if not hrp then return end
            
            -- CFrame을 회전시킴
            hrp.CFrame = hrp.CFrame * CFrame.Angles(0, math.rad(spinSpeed), 0)
        end)
        
        StarterGui:SetCore("SendNotification", {Title = "Spin 활성화", Text = "회전 속도: " .. spinSpeed, Duration = 3})
    else
        spinEnabled = false
        if spinConnection then
            spinConnection:Disconnect()
            spinConnection = nil
        end
        StarterGui:SetCore("SendNotification", {Title = "Spin 해제", Text = "회전이 멈췄습니다.", Duration = 3})
    end
end

-- [Fly & VFly - Velocity Fly 방식 적용]
local function startFlying(mode, speedInput)
    if flyConnection then flyConnection:Disconnect() flyConnection = nil end
    if lp.Character then
        local hum = lp.Character:FindFirstChild("Humanoid")
        if hum then hum.PlatformStand = false end
        for _, obj in pairs(flyObjects) do if obj then obj:Destroy() end end
        flyObjects = {}
        for _, v in pairs(lp.Character:GetDescendants()) do
            if v.Name == "VelocityFly_BV" or v.Name == "VelocityFly_BG" then v:Destroy() end
        end
    end

    currentFlyType = mode
    
    local desired = tonumber(speedInput)
    if desired then flySpeed = desired * 10 else flySpeed = 50 end
    if flySpeed < 1 then flySpeed = 50 end

    flyConnection = RunService.RenderStepped:Connect(function()
        local char = lp.Character
        if not char then return end
        
        local hum = char:FindFirstChild("Humanoid")
        local hrp = char:FindFirstChild("HumanoidRootPart")
        if not hum or not hrp then return end

        local targetPart = hrp
        local isInVehicle = false
        
        if mode == "vfly" and hum.SeatPart then
            targetPart = hum.SeatPart
            isInVehicle = true
            if targetPart.Parent:IsA("Model") and targetPart.Parent.PrimaryPart then
                targetPart = targetPart.Parent.PrimaryPart
            end
        end

        local bv = targetPart:FindFirstChild("VelocityFly_BV")
        local bg = targetPart:FindFirstChild("VelocityFly_BG")

        if not bv then
            bv = Instance.new("BodyVelocity")
            bv.Name = "VelocityFly_BV"
            bv.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
            bv.Velocity = Vector3.new(0, 0, 0)
            bv.Parent = targetPart
            table.insert(flyObjects, bv)
        end
        if not bg then
            bg = Instance.new("BodyGyro")
            bg.Name = "VelocityFly_BG"
            bg.P = 9e4
            bg.MaxTorque = Vector3.new(math.huge, math.huge, math.huge)
            bg.CFrame = targetPart.CFrame
            bg.Parent = targetPart
            table.insert(flyObjects, bg)
        end

        local cam = workspace.CurrentCamera
        local moveDir = Vector3.new(0, 0, 0)
        local cf = cam.CFrame
        
        if not UserInputService:GetFocusedTextBox() then
            if UserInputService:IsKeyDown(Enum.KeyCode.W) then moveDir = moveDir + cf.LookVector end
            if UserInputService:IsKeyDown(Enum.KeyCode.S) then moveDir = moveDir - cf.LookVector end
            if UserInputService:IsKeyDown(Enum.KeyCode.A) then moveDir = moveDir - cf.RightVector end
            if UserInputService:IsKeyDown(Enum.KeyCode.D) then moveDir = moveDir + cf.RightVector end
        end
        
        bv.Velocity = moveDir * flySpeed
        bg.CFrame = cf 

        if hum then
            if isInVehicle then 
                hum.PlatformStand = false 
            else 
                hum.PlatformStand = true 
            end
        end
    end)
    
    local titleText = (mode == "vfly") and "VFly (Velocity) 켜짐" or "Fly (Velocity) 켜짐"
    StarterGui:SetCore("SendNotification", {Title = titleText, Text = "속도: " .. flySpeed, Duration = 3})
end

local function stopFlying()
    if flyConnection then flyConnection:Disconnect() flyConnection = nil end
    
    for _, obj in pairs(flyObjects) do
        if obj and obj.Parent then obj:Destroy() end
    end
    flyObjects = {}
    
    if lp.Character then
        for _, v in pairs(lp.Character:GetDescendants()) do
            if v.Name == "VelocityFly_BV" or v.Name == "VelocityFly_BG" then v:Destroy() end
        end
        local hum = lp.Character:FindFirstChild("Humanoid")
        if hum then hum.PlatformStand = false end
    end
    currentFlyType = nil
end

-- [tpwalk]
local function startTpwalk(step)
    if tpwalkConnection then tpwalkConnection:Disconnect() tpwalkConnection = nil end
    tpwalkEnabled = true
    tpwalkStep = tonumber(step) or 1
    if tpwalkStep <= 0 then tpwalkStep = 1 end

    tpwalkConnection = RunService.Heartbeat:Connect(function()
        if not tpwalkEnabled then return end
        if cmdFocused then return end
        if not lp.Character then return end
        local hrp = lp.Character:FindFirstChild("HumanoidRootPart")
        if not hrp then return end
        local cam = workspace.CurrentCamera
        if not cam then return end

        local look = cam.CFrame.LookVector
        local right = cam.CFrame.RightVector
        look = Vector3.new(look.X, 0, look.Z)
        right = Vector3.new(right.X, 0, right.Z)
        
        if look.Magnitude == 0 then return end
        look = look.Unit
        if right.Magnitude == 0 then right = look:Cross(Vector3.new(0,1,0)).Unit end

        local moveDir = Vector3.new(0,0,0)
        if UserInputService:IsKeyDown(Enum.KeyCode.W) then moveDir = moveDir + look end
        if UserInputService:IsKeyDown(Enum.KeyCode.S) then moveDir = moveDir - look end
        if UserInputService:IsKeyDown(Enum.KeyCode.A) then moveDir = moveDir - right end
        if UserInputService:IsKeyDown(Enum.KeyCode.D) then moveDir = moveDir + right end

        if moveDir.Magnitude > 0 then
            local dir = moveDir.Unit
            local targetPos = hrp.Position + dir * tpwalkStep
            local lookPos = targetPos + dir
            local flatLookPos = Vector3.new(lookPos.X, targetPos.Y, lookPos.Z)

            pcall(function() 
                hrp.CFrame = CFrame.lookAt(targetPos, flatLookPos) 
            end)
        end
    end)
    StarterGui:SetCore("SendNotification", {Title = "TpWalk 켜짐", Text = "스텝: " .. tostring(tpwalkStep) .. " studs (자유 시점)", Duration = 4})
end

local function stopTpwalk()
    tpwalkEnabled = false
    if tpwalkConnection then tpwalkConnection:Disconnect() tpwalkConnection = nil end
    StarterGui:SetCore("SendNotification", {Title = "TpWalk 꺼짐", Text = "이제 텔레포트 보행이 중지됩니다.", Duration = 2})
end

-- ==============================================================================
-- [ 음식 뺏어가기 기능 (TakeFood) ]
-- ==============================================================================

local function toggleTakeFood(state)
    if state then
        if takeFoodEnabled then return end
        takeFoodEnabled = true
        if getgenv then getgenv().TakeFoodActive = true else _G.TakeFoodActive = true end

        local VoidCFrame = CFrame.new(0, -30000, 0)
        local ZeroVector = Vector3.new(0, 0, 0)
        local MySpawnFolderName = lp.Name .. "SpawnedInToys"
        
        local TargetItems = {
            ["InstrumentBrassBugle"] = true, ["InstrumentBrassTrumpet"] = true, ["InstrumentBrassVuvuzela"] = true,
            ["InstrumentDrumBongos"] = true, ["InstrumentDrumSnare"] = true, ["InstrumentGuitarAcoustic"] = true,
            ["InstrumentGuitarBanjo"] = true, ["InstrumentGuitarLyre"] = true, ["InstrumentGuitarUkulele"] = true,
            ["InstrumentGuitarViolin"] = true, ["InstrumentPianoKeyboard"] = true, ["InstrumentPianoMelodica"] = true,
            ["InstrumentVoiceMicrophone"] = true, ["InstrumentWoodwindOcarina"] = true, ["InstrumentWoodwindSaxophone"] = true,
            ["PoopPileSparkle"] = true, ["PoopPile"] = true, ["FoodSodaCan"] = true, ["FoodPizzaPepperoni"] = true,
            ["FoodPizzaCheese"] = true, ["FoodMushroomPoison"] = true, ["FoodMeatStick"] = true, ["FoodMayonnaise"] = true,
            ["FoodHotdog"] = true, ["FoodHamburger"] = true, ["FoodFrenchFries"] = true, ["FoodDonut"] = true,
            ["FoodDippyEgg"] = true, ["FoodCoconut"] = true, ["FoodCakePink"] = true, ["FoodBroccoli"] = true,
            ["FoodBread"] = true, ["FoodBanana"] = true, ["CupMugWhite"] = true, ["CupMugBrown"] = true
        }

        local function AggressiveRemove(item)
            if not takeFoodEnabled then return end
            if not item then return end
            
            if takeFoodTargets[item] then return end
            
            if not TargetItems[item.Name] then return end
            if item:IsDescendantOf(Workspace) then
                local myFolder = Workspace:FindFirstChild(MySpawnFolderName)
                if myFolder and item:IsDescendantOf(myFolder) then return end
            end

            takeFoodTargets[item] = true

            task.spawn(function()
                local holdPart = item:WaitForChild("HoldPart", 2)
                if not holdPart or not takeFoodEnabled then 
                    takeFoodTargets[item] = nil 
                    return 
                end
                
                local holdRemote = holdPart:WaitForChild("HoldItemRemoteFunction", 2)
                local dropRemote = holdPart:WaitForChild("DropItemRemoteFunction", 2)

                if holdRemote and dropRemote then
                    while takeFoodEnabled and item and item.Parent and item:IsDescendantOf(Workspace) do
                        local myFolder = Workspace:FindFirstChild(MySpawnFolderName)
                        if myFolder and item:IsDescendantOf(myFolder) then
                            takeFoodTargets[item] = nil
                            return
                        end

                        task.spawn(function()
                            pcall(function() holdRemote:InvokeServer(item, lp.Character) end)
                        end)
                        
                        task.wait(0.1) 

                        task.spawn(function()
                            pcall(function() dropRemote:InvokeServer(item, VoidCFrame, ZeroVector) end)
                        end)
                        
                        task.wait(0.1)
                    end
                    takeFoodTargets[item] = nil
                else
                    takeFoodTargets[item] = nil
                end
            end)
        end

        local function AttachDeepWatch(folder)
            if not folder then return end
            for _, descendant in pairs(folder:GetDescendants()) do
                if takeFoodEnabled then AggressiveRemove(descendant) end
            end
            local conn = folder.DescendantAdded:Connect(function(descendant)
                if takeFoodEnabled then AggressiveRemove(descendant) end
            end)
            table.insert(takeFoodConnections, conn)
        end

        local foodFolder = Workspace:FindFirstChild("Food")
        if foodFolder then AttachDeepWatch(foodFolder) end

        local plotFolder = Workspace:FindFirstChild("PlotItems")
        if plotFolder then AttachDeepWatch(plotFolder) end
        
        local function CheckAndAttach(child)
            if child:IsA("Folder") or child:IsA("Model") then
                if string.match(child.Name, "SpawnedInToys$") and child.Name ~= MySpawnFolderName then
                    AttachDeepWatch(child)
                end
            end
        end

        for _, child in pairs(Workspace:GetChildren()) do CheckAndAttach(child) end
        
        local wsConn = Workspace.ChildAdded:Connect(function(child)
            if not takeFoodEnabled then return end
            if child.Name == "Food" or child.Name == "PlotItems" then
                AttachDeepWatch(child)
            else
                CheckAndAttach(child)
            end
        end)
        table.insert(takeFoodConnections, wsConn)

        local scanLoop = task.spawn(function()
            while takeFoodEnabled do
                local itemsChecked = 0
                
                local foldersToScan = {}
                if foodFolder then table.insert(foldersToScan, foodFolder) end
                if plotFolder then table.insert(foldersToScan, plotFolder) end
                for _, child in pairs(Workspace:GetChildren()) do
                    if string.match(child.Name, "SpawnedInToys$") and child.Name ~= MySpawnFolderName then
                        table.insert(foldersToScan, child)
                    end
                end

                for _, folder in pairs(foldersToScan) do
                    if not takeFoodEnabled then break end
                    
                    local descendants = folder:GetDescendants()
                    for _, item in pairs(descendants) do
                        if not takeFoodEnabled then break end
                        
                        if TargetItems[item.Name] and not takeFoodTargets[item] then 
                            AggressiveRemove(item) 
                        end
                        
                        itemsChecked = itemsChecked + 1
                        if itemsChecked % 50 == 0 then 
                            task.wait() 
                        end
                    end
                    task.wait()
                end
                
                task.wait(0.1)
            end
        end)
        
        StarterGui:SetCore("SendNotification", {Title = "음식 뺏어가기 켜짐", Text = "주변 아이템을 자동으로 가져옵니다.", Duration = 3})
    else
        takeFoodEnabled = false
        if getgenv then getgenv().TakeFoodActive = false else _G.TakeFoodActive = false end
        
        for _, conn in pairs(takeFoodConnections) do
            if conn then conn:Disconnect() end
        end
        takeFoodConnections = {}
        
        takeFoodTargets = {}
        
        StarterGui:SetCore("SendNotification", {Title = "음식 뺏어가기 꺼짐", Text = "기능을 비활성화하고 루프를 정지했습니다.", Duration = 3})
    end
end

-- ==============================================================================
-- [ Anti-Barrier & Ocean Walk 기능 ]
-- ==============================================================================

local function toggleAntiBarrier(state)
    local targetCollide = not state 
    local count = 0
    for i = 1, 5 do
        local folder = Workspace:FindFirstChild("Plots") and Workspace.Plots:FindFirstChild("Plot" .. i) and Workspace.Plots["Plot" .. i]:FindFirstChild("Barrier")
        if folder then
            for _, v in pairs(folder:GetChildren()) do
                if v.Name == "PlotBarrier" and v:IsA("BasePart") then
                    v.CanCollide = targetCollide
                    count = count + 1
                end
            end
        end
    end
    
    if state then
        StarterGui:SetCore("SendNotification", {Title = "AntiBarrier 켜짐", Text = "플롯 장벽 충돌을 껐습니다.", Duration = 3})
    else
        StarterGui:SetCore("SendNotification", {Title = "AntiBarrier 꺼짐", Text = "플롯 장벽 충돌을 다시 켰습니다.", Duration = 3})
    end
end

local function toggleOceanWalk(state)
    local oceanModel = Workspace:FindFirstChild("Map") 
        and Workspace.Map:FindFirstChild("AlwaysHereTweenedObjects") 
        and Workspace.Map.AlwaysHereTweenedObjects:FindFirstChild("Ocean") 
        and Workspace.Map.AlwaysHereTweenedObjects.Ocean:FindFirstChild("Object")
        and Workspace.Map.AlwaysHereTweenedObjects.Ocean.Object:FindFirstChild("ObjectModel")
    
    if oceanModel then
        local count = 0
        for _, v in pairs(oceanModel:GetDescendants()) do
            if v.Name == "Ocean" and v:IsA("BasePart") then
                v.CanCollide = state
                count = count + 1
            end
        end
        
        if state then
            StarterGui:SetCore("SendNotification", {Title = "OceanWalk 켜짐", Text = "바다 위를 걸을 수 있습니다.", Duration = 3})
        else
            StarterGui:SetCore("SendNotification", {Title = "OceanWalk 꺼짐", Text = "다시 물 속으로 빠집니다.", Duration = 3})
        end
    else
        StarterGui:SetCore("SendNotification", {Title = "오류", Text = "Ocean 경로를 찾을 수 없습니다.", Duration = 3})
    end
end

-- ==============================================================================
-- [ Anti-Bomb (오븐 방어) 기능 ]
-- ==============================================================================
local function toggleAntiBomb(state)
    if state then
        if antiBombEnabled then 
            StarterGui:SetCore("SendNotification", {Title = "안티 폭탄", Text = "이미 실행 중입니다.", Duration = 2})
            return 
        end
        antiBombEnabled = true

        task.spawn(function()
            local Character = lp.Character or lp.CharacterAdded:Wait()
            local HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")
            if not HumanoidRootPart then return end

            local OriginalCFrame = HumanoidRootPart.CFrame

            local SetupCoordinate = Vector3.new(541.4873046875, -5.359338283538818, -266.456787109375)
            HumanoidRootPart.CFrame = CFrame.new(SetupCoordinate)
            task.wait(0.05) 

            local spawnRemote = ReplicatedStorage:WaitForChild("MenuToys"):WaitForChild("SpawnToyRemoteFunction")
            local spawnPos = HumanoidRootPart.CFrame * CFrame.new(0, 0, -5)
            spawnRemote:InvokeServer("OvenDarkGray", spawnPos, Vector3.new(0, 0, 0))

            local myToyFolderName = lp.Name .. "SpawnedInToys" 
            local myToyFolder = Workspace:WaitForChild(myToyFolderName, 5)
            if not myToyFolder then 
                warn("Toy 폴더를 찾을 수 없음")
                HumanoidRootPart.CFrame = OriginalCFrame
                antiBombEnabled = false
                return 
            end
            
            local myOven = myToyFolder:WaitForChild("OvenDarkGray", 5)
            if not myOven then
                warn("오븐을 찾을 수 없습니다.")
                HumanoidRootPart.CFrame = OriginalCFrame
                antiBombEnabled = false
                StarterGui:SetCore("SendNotification", {Title = "안티 폭탄 실패", Text = "오븐 스폰에 실패했습니다.", Duration = 3})
                return
            end
            
            currentOven = myOven
            local ovenMain = myOven:WaitForChild("Main")

            if HumanoidRootPart and ovenMain then
                HumanoidRootPart.CFrame = ovenMain.CFrame * CFrame.new(0, 0, 10)
            end
            
            task.wait(0.05)

            local interactRemote = ReplicatedStorage:WaitForChild("GrabEvents"):WaitForChild("SetNetworkOwner")
            local ButtonSequence = {"Button1", "Button2", "ButtonOven", "Button3", "Button4"}

            local soundPart = myOven:WaitForChild("SoundPart", 2)
            if soundPart then interactRemote:FireServer(soundPart, soundPart.CFrame) end

            for _, btnName in ipairs(ButtonSequence) do
                local btn = myOven:WaitForChild(btnName, 2)
                if btn then
                    interactRemote:FireServer(btn, btn.CFrame)
                    task.wait() 
                end
            end

            if HumanoidRootPart then
                HumanoidRootPart.CFrame = OriginalCFrame
            end
            
            StarterGui:SetCore("SendNotification", {Title = "안티 폭탄 켜짐", Text = "오븐을 설치하고 방어 모드를 시작합니다.", Duration = 3})

            local TargetBombNames = {
                ["BombMissile"] = true, ["BombDarkMatter"] = true,
                ["BombBalloon"] = true, ["BallSnowball"] = true, ["BalloonModel"] = true
            }
            local SafeZoneCFrame = CFrame.new(0, 500000, 0)

            while antiBombEnabled and myOven and myOven.Parent do
                local foundTarget = nil
                local targetCFrame = nil

                for _, folder in pairs(Workspace:GetChildren()) do
                    if string.sub(folder.Name, -13) == "SpawnedInToys" then
                        if folder.Name == myToyFolderName then continue end 
                        for _, toy in pairs(folder:GetChildren()) do
                            if TargetBombNames[toy.Name] then
                                foundTarget = toy
                                break
                            end
                        end
                    end
                    if foundTarget then break end
                end
                
                if not foundTarget then
                    local balloonsFolder = Workspace:FindFirstChild("Balloons")
                    if balloonsFolder then
                        for _, toy in pairs(balloonsFolder:GetChildren()) do
                            if TargetBombNames[toy.Name] then
                                foundTarget = toy
                                break
                            end
                        end
                    end
                end

                if foundTarget and foundTarget.Parent.Name == myToyFolderName then foundTarget = nil end

                if foundTarget then
                    if foundTarget.Name == "BombBalloon" or foundTarget.Name == "BalloonModel" then
                        targetCFrame = foundTarget:GetPivot()
                    elseif foundTarget:FindFirstChild("Main") then
                        targetCFrame = foundTarget.Main.CFrame
                    end

                    if targetCFrame then
                        for i = 0.3, 5 do
                            if not foundTarget or not foundTarget.Parent then break end
                            if not antiBombEnabled then break end

                            if foundTarget.Name == "BombBalloon" or foundTarget.Name == "BalloonModel" then
                                targetCFrame = foundTarget:GetPivot()
                            elseif foundTarget:FindFirstChild("Main") then
                                targetCFrame = foundTarget.Main.CFrame
                            end
                            
                            ovenMain.CFrame = targetCFrame
                            ovenMain.Velocity = Vector3.zero
                            ovenMain.RotVelocity = Vector3.zero
                            RunService.Heartbeat:Wait()

                            ovenMain.CFrame = SafeZoneCFrame
                            ovenMain.Velocity = Vector3.zero
                            ovenMain.RotVelocity = Vector3.zero
                            RunService.Heartbeat:Wait()
                        end
                    end
                else
                    ovenMain.CFrame = SafeZoneCFrame
                    ovenMain.Velocity = Vector3.zero
                    ovenMain.RotVelocity = Vector3.zero
                    task.wait()
                end
            end
        end)
    else
        antiBombEnabled = false
        
        if currentOven and currentOven.Parent then
            local args = { currentOven }
            pcall(function()
                game:GetService("ReplicatedStorage"):WaitForChild("MenuToys"):WaitForChild("DestroyToy"):FireServer(unpack(args))
            end)
            StarterGui:SetCore("SendNotification", {Title = "안티 폭탄 꺼짐", Text = "설치된 오븐을 삭제했습니다.", Duration = 3})
            currentOven = nil
        else
            local args = { Instance.new("Model", nil) } 
            pcall(function()
                game:GetService("ReplicatedStorage"):WaitForChild("MenuToys"):WaitForChild("DestroyToy"):FireServer(unpack(args))
            end)
            StarterGui:SetCore("SendNotification", {Title = "안티 폭탄 꺼짐", Text = "오븐 삭제 신호를 보냈습니다.", Duration = 3})
        end
    end
end


-- ==============================================================================
-- [ AntiInPlots (플롯 내부 납치) 기능 ]
-- ==============================================================================
local function toggleAntiInPlots(state)
    if state then
        if antiInPlotsEnabled then return end
        antiInPlotsEnabled = true
        
        task.spawn(function()
            local plotItems = Workspace:WaitForChild("PlotItems", 5)
            local playersInPlots = plotItems and plotItems:WaitForChild("PlayersInPlots", 5)
            
            local mySpawnFolderName = lp.Name .. "SpawnedInToys"
            local mySpawnFolder = Workspace:WaitForChild(mySpawnFolderName, 5)

            if not playersInPlots or not mySpawnFolder then
                StarterGui:SetCore("SendNotification", {Title = "오류", Text = "필수 폴더(PlotItems/SpawnedInToys)를 찾을 수 없습니다.", Duration = 3})
                antiInPlotsEnabled = false
                return
            end
            
            StarterGui:SetCore("SendNotification", {Title = "AntiInPlots 켜짐", Text = "플롯 내부 플레이어를 납치합니다.", Duration = 3})

            while antiInPlotsEnabled do
                if not mySpawnFolder or not mySpawnFolder.Parent then
                    mySpawnFolder = Workspace:FindFirstChild(mySpawnFolderName)
                end

                if mySpawnFolder then
                    for _, player in pairs(Players:GetPlayers()) do
                        local char = player.Character
                        if char and char.Parent then
                            local inPlot = playersInPlots:FindFirstChild(player.Name)

                            if inPlot then
                                if char.Parent ~= mySpawnFolder then
                                    pcall(function()
                                        char.Parent = mySpawnFolder
                                    end)
                                end
                            end
                        end
                    end
                end
                task.wait(0.2)
            end
        end)
    else
        antiInPlotsEnabled = false
        StarterGui:SetCore("SendNotification", {Title = "AntiInPlots 꺼짐", Text = "기능이 비활성화되었습니다.", Duration = 3})
    end
end


-- [명령어 처리 통합 함수]
local function processCommand(msg)
    msg = msg:gsub("^%s+", ""):gsub("%s+$", "")
    if #msg == 0 then return end

    local lowerMsg = msg:lower()

    if lowerMsg == ".iconesp" or lowerMsg == ".ie" then toggleIconEsp(true)
    elseif lowerMsg == ".uniconesp" or lowerMsg == ".unie" then toggleIconEsp(false)
    elseif lowerMsg:sub(1, 6) == ".chat " then sendChatMessage(msg:sub(7))
    elseif lowerMsg:sub(1, 5) == ".say " then sendChatMessage(msg:sub(6))

    elseif lowerMsg == ".fpsboost" or lowerMsg == ".fps" then toggleFpsBoost(true)
    elseif lowerMsg == ".unfpsboost" or lowerMsg == ".unfps" then toggleFpsBoost(false)

    elseif lowerMsg == ".antiafk" then toggleAntiAfk(true)
    elseif lowerMsg == ".unantiafk" then toggleAntiAfk(false)
    
    elseif lowerMsg == ".showplcd" or lowerMsg == ".plcd" then togglePlcd(true)
    elseif lowerMsg == ".hideplcd" or lowerMsg == ".unplcd" then togglePlcd(false)

    elseif lowerMsg == ".delplcd" or lowerMsg == ".breakplcd" then 
        toggleAutoReset(true)
    elseif lowerMsg == ".undelplcd" or lowerMsg == ".unbreakplcd" then 
        toggleAutoReset(false)

    elseif lowerMsg == ".takefood" or lowerMsg == ".tf" then
        toggleTakeFood(true)
    elseif lowerMsg == ".untakefood" or lowerMsg == ".untf" then
        toggleTakeFood(false)

    elseif lowerMsg == ".antibarrier" or lowerMsg == ".barrier" then
        toggleAntiBarrier(true)
    elseif lowerMsg == ".unantibarrier" or lowerMsg == ".unbarrier" then
        toggleAntiBarrier(false)

    elseif lowerMsg == ".breakbarrier" then
        loadstring(game:HttpGet('https://raw.githubusercontent.com/dosi1100-cmyk/script/refs/heads/main/breakbarrier'))()
    elseif lowerMsg == ".unbreakbarrier" then
        loadstring(game:HttpGet('https://raw.githubusercontent.com/dosi1100-cmyk/script/refs/heads/main/breakbarrier'))()

    elseif lowerMsg == ".antibomb" or lowerMsg == ".ab" then
        toggleAntiBomb(true)
    elseif lowerMsg == ".unantibomb" or lowerMsg == ".unab" then
        toggleAntiBomb(false)

    elseif lowerMsg == ".antiinplots" or lowerMsg == ".aip" then
        toggleAntiInPlots(true)
    elseif lowerMsg == ".unantiinplots" or lowerMsg == ".unaip" then
        toggleAntiInPlots(false)

    elseif lowerMsg == ".dellines" or lowerMsg == ".dl" then
        toggleDelLines(true)
    elseif lowerMsg == ".undellines" or lowerMsg == ".undl" then
        toggleDelLines(false)

    elseif lowerMsg == ".oceanwalk" then
        toggleOceanWalk(true)
        
    elseif lowerMsg == ".unoceanwalk" or lowerMsg == ".unow" then
        toggleOceanWalk(false)
        
    elseif lowerMsg == ".antilag" then
        if not antiLagLoop then
            toggleAntiLag(true)
            StarterGui:SetCore("SendNotification", {Title = "Anti-Lag 켜짐", Text = "FPS<8 또는 수신>2000kbps 시 자동 종료", Duration = 3})
        else
            StarterGui:SetCore("SendNotification", {Title = "Anti-Lag", Text = "이미 켜져 있습니다.", Duration = 2})
        end

    elseif lowerMsg == ".unantilag" then
        toggleAntiLag(false)
        StarterGui:SetCore("SendNotification", {Title = "Anti-Lag 꺼짐", Text = "자동 종료 감지가 해제되었습니다.", Duration = 3})

    elseif lowerMsg == ".재접" or lowerMsg == ".rj" then
        pcall(function()
            if #Players:GetPlayers() <= 1 then TeleportService:Teleport(game.PlaceId, lp)
            else TeleportService:TeleportToPlaceInstance(game.PlaceId, game.JobId, lp) end
        end)

    elseif lowerMsg == ".kg" then
        loadstring(game:HttpGet('https://raw.githubusercontent.com/dosi1100-cmyk/script/refs/heads/main/KickGrab'))()
    elseif lowerMsg == ".unkg" then    
        loadstring(game:HttpGet('https://raw.githubusercontent.com/dosi1100-cmyk/script/refs/heads/main/KickGrab'))()
    
    elseif lowerMsg == ".svhop" then
        StarterGui:SetCore("SendNotification", {Title = "서버 이동", Text = "다른 서버를 찾는 중...", Duration = 3})
        if not http_request then StarterGui:SetCore("SendNotification", {Title = "오류", Text = "HTTP 미지원", Duration = 3}) return end
        local servers = {}
        local url = string.format("https://games.roblox.com/v1/games/%d/servers/Public?sortOrder=Desc&limit=100", game.PlaceId)
        pcall(function()
            local req = http_request({Url = url, Method = "GET"})
            local body = HttpService:JSONDecode(req.Body)
            if body and body.data then
                for _, v in ipairs(body.data) do
                    if type(v) == "table" and v.maxPlayers > v.playing and v.id ~= game.JobId then
                         table.insert(servers, v.id)
                    end
                end
            end
        end)
        if #servers > 0 then
            local randomServer = servers[math.random(1, #servers)]
            StarterGui:SetCore("SendNotification", {Title = "이동 시작", Text = "새로운 서버로 이동합니다.", Duration = 3})
            TeleportService:TeleportToPlaceInstance(game.PlaceId, randomServer, lp)
        else StarterGui:SetCore("SendNotification", {Title = "실패", Text = "이동할 서버를 찾지 못했습니다.", Duration = 3}) end

    elseif lowerMsg == ".렉" or lowerMsg == ".lag" then
        pcall(function() loadstring(game:HttpGet("https://raw.githubusercontent.com/dosi1100-cmyk/script/refs/heads/main/ServerLag"))() end)

    elseif lowerMsg == ".에임봇" or lowerMsg == ".aimbot" then
        pcall(function() loadstring(game:HttpGet("https://raw.githubusercontent.com/dosi1100-cmyk/script/refs/heads/main/aimbot"))() end)

    elseif lowerMsg == ".도움" or lowerMsg == ".help" then
        if helpFrame then helpFrame.Visible = not helpFrame.Visible end
        
    elseif lowerMsg == ".reset" or lowerMsg == ".die" then
        if lp.Character then
            local head = lp.Character:FindFirstChild("Head")
            if head then head:Destroy() end
            lp.Character:BreakJoints()
            StarterGui:SetCore("SendNotification", {Title = "사망 처리", Text = "캐릭터를 강제 사망시켰습니다.", Duration = 2})
        end

    elseif lowerMsg:sub(1, 7) == ".speed " then
        local val = tonumber(msg:sub(8))
        if val and lp.Character and lp.Character:FindFirstChild("Humanoid") then
            lp.Character.Humanoid.WalkSpeed = val
            StarterGui:SetCore("SendNotification", {Title = "속도 설정", Text = "WalkSpeed: " .. val, Duration = 2})
        end

    elseif lowerMsg:sub(1, 5) == ".fov " then
        local val = tonumber(msg:sub(6))
        if val then
            workspace.CurrentCamera.FieldOfView = val
            StarterGui:SetCore("SendNotification", {Title = "FOV 변경", Text = "시야각이 " .. val .. "(으)로 설정되었습니다.", Duration = 2})
        end

    elseif lowerMsg:sub(1, 11) == ".loopspeed " then
        local val = tonumber(msg:sub(12))
        if val then
            targetWalkSpeed = val
            if not loopSpeedConnection then
                loopSpeedConnection = RunService.Heartbeat:Connect(function()
                    if lp.Character and lp.Character:FindFirstChild("Humanoid") then
                        lp.Character.Humanoid.WalkSpeed = targetWalkSpeed
                    end
                end)
            end
            StarterGui:SetCore("SendNotification", {Title = "속도 고정됨", Text = "항상 " .. val .. "로 유지됩니다.", Duration = 2})
        end

    elseif lowerMsg == ".unloopspeed" then
        if loopSpeedConnection then
            loopSpeedConnection:Disconnect()
            loopSpeedConnection = nil
            StarterGui:SetCore("SendNotification", {Title = "속도 고정 해제", Text = "이제 속도가 고정되지 않습니다.", Duration = 2})
        else StarterGui:SetCore("SendNotification", {Title = "알림", Text = "속도 고정이 켜져있지 않습니다.", Duration = 2}) end

    elseif lowerMsg:sub(1, 11) == ".jumppower " or lowerMsg:sub(1, 5) == ".jpp " then
        local val
        if lowerMsg:sub(1, 11) == ".jumppower " then val = tonumber(msg:sub(12)) else val = tonumber(msg:sub(6)) end
        if val and lp.Character and lp.Character:FindFirstChild("Humanoid") then
            lp.Character.Humanoid.UseJumpPower = true
            lp.Character.Humanoid.JumpPower = val
            StarterGui:SetCore("SendNotification", {Title = "점프력 설정", Text = "JumpPower: " .. val, Duration = 2})
        end

    elseif lowerMsg:sub(1, 15) == ".loopjumppower " or lowerMsg:sub(1, 9) == ".loopjpp " then
        local val
        if lowerMsg:sub(1, 15) == ".loopjumppower " then val = tonumber(msg:sub(16)) else val = tonumber(msg:sub(10)) end
        if val then
            targetJumpPower = val
            if not loopJumpConnection then
                loopJumpConnection = RunService.Heartbeat:Connect(function()
                    if lp.Character and lp.Character:FindFirstChild("Humanoid") then
                        lp.Character.Humanoid.UseJumpPower = true
                        lp.Character.Humanoid.JumpPower = targetJumpPower
                    end
                end)
            end
            StarterGui:SetCore("SendNotification", {Title = "점프력 고정됨", Text = "항상 " .. val .. "로 유지됩니다.", Duration = 2})
        end

    elseif lowerMsg == ".unloopjumppower" or lowerMsg == ".unloopjpp" then
        if loopJumpConnection then
            loopJumpConnection:Disconnect()
            loopJumpConnection = nil
            StarterGui:SetCore("SendNotification", {Title = "점프력 고정 해제", Text = "이제 점프력이 고정되지 않습니다.", Duration = 2})
        else StarterGui:SetCore("SendNotification", {Title = "알림", Text = "점프력 고정이 켜져있지 않습니다.", Duration = 2}) end

    elseif lowerMsg == ".unjpp" then
         if lp.Character and lp.Character:FindFirstChild("Humanoid") then lp.Character.Humanoid.JumpPower = 50 end
        StarterGui:SetCore("SendNotification", {Title = "점프력 초기화", Text = "점프력이 50으로 초기화되었습니다.", Duration = 2})

    elseif lowerMsg:sub(1,8) == ".tpwalk " then
        local num = tonumber(msg:sub(9))
        if num and num > 0 then startTpwalk(num) else StarterGui:SetCore("SendNotification", {Title = "사용법", Text = ".tpwalk <숫자>", Duration = 4}) end

    elseif lowerMsg == ".untpwalk" then stopTpwalk()

    elseif lowerMsg == ".핑" then
        local ping = math.floor(lp:GetNetworkPing() * 1000)
        StarterGui:SetCore("SendNotification", {Title = "핑 확인", Text = "현재 핑: " .. ping .. "ms", Duration = 3})

    elseif lowerMsg == ".친구" or lowerMsg == ".친구 목록" or lowerMsg == ".fl" then toggleFriendList()
    elseif lowerMsg == ".서버 정보" or lowerMsg == ".svinfo" then
        if not serverInfoGui or not serverInfoGui.Parent then createServerInfoGui() else serverInfoGui.Enabled = not serverInfoGui.Enabled end

    elseif lowerMsg:sub(1, 6) == ".join " then
        local targetNamePart = lowerMsg:sub(7)
        local success, onlineFriends = pcall(function() return lp:GetFriendsOnline(200) end)
        if success then
            local foundFriend = nil
            for _, friend in ipairs(onlineFriends) do
                local fName = friend.UserName:lower()
                local fDisplay = friend.DisplayName:lower()
                if fName:sub(1, #targetNamePart) == targetNamePart or fDisplay:sub(1, #targetNamePart) == targetNamePart then
                    foundFriend = friend
                    break
                end
            end
            if foundFriend then
                StarterGui:SetCore("SendNotification", {Title = "접속 시도", Text = foundFriend.UserName .. "님에게 이동합니다...", Duration = 3})
                local placeId = foundFriend.PlaceId
                if placeId then
                    if placeId ~= game.PlaceId then TeleportService:Teleport(placeId, lp)
                    else
                         pcall(function() TeleportService:TeleportToPlaceInstance(placeId, foundFriend.GameId, lp) end)
                    end
                end
            else StarterGui:SetCore("SendNotification", {Title = "찾을 수 없음", Text = "친구가 오프라인이거나 찾을 수 없습니다.", Duration = 3}) end
        end

    elseif lowerMsg == ".jobid" then
        setclipboard(tostring(game.JobId))
        StarterGui:SetCore("SendNotification", {Title = "복사 완료", Text = "Job ID가 복사되었습니다.", Duration = 2})

    elseif lowerMsg:sub(1, 5) == ".age " then
        local targetNamePart = lowerMsg:sub(6)
        local targetP = nil
        for _, p in ipairs(Players:GetPlayers()) do
            local pName = p.Name:lower()
            local pDisplay = p.DisplayName:lower()
            if pName:sub(1, #targetNamePart) == targetNamePart or pDisplay:sub(1, #targetNamePart) == targetNamePart then
                targetP = p
                break
            end
        end
        if targetP then
            local days = targetP.AccountAge
            local years = math.floor(days / 365)
            local remainingDays = days % 365
            local months = math.floor(remainingDays / 30)
            local createdTime = os.time() - (days * 86400)
            local createdDate = os.date("%Y년 %m월 %d일", createdTime)
            local ageText = days .. "일 (약 " .. years .. "년 " .. months .. "개월)"
            StarterGui:SetCore("SendNotification", { Title = targetP.Name .. " 정보", Text = "계정 나이: " .. ageText .. "\n가입일: " .. createdDate, Duration = 6 })
        else 
            StarterGui:SetCore("SendNotification", {Title = "오류", Text = "플레이어를 찾을 수 없습니다.", Duration = 3}) 
        end

    elseif lowerMsg == ".fullbright" or lowerMsg == ".fb" then
        if not fullbrightLoop then
            savedLightingSettings = { Brightness = Lighting.Brightness, ClockTime = Lighting.ClockTime, FogEnd = Lighting.FogEnd, GlobalShadows = Lighting.GlobalShadows, OutdoorAmbient = Lighting.OutdoorAmbient, Ambient = Lighting.Ambient }
            fullbrightLoop = RunService.RenderStepped:Connect(function()
                Lighting.Brightness = 2
                Lighting.ClockTime = 13
                Lighting.FogEnd = 70000
                Lighting.GlobalShadows = false
                Lighting.OutdoorAmbient = Color3.fromRGB(255, 255, 255)
                Lighting.Ambient = Color3.fromRGB(255, 255, 255)
            end)
            StarterGui:SetCore("SendNotification", {Title = "Fullbright 켜짐", Text = "맵이 최대 밝기로 유지됩니다.", Duration = 3})
        else
            fullbrightLoop:Disconnect()
            fullbrightLoop = nil
            if savedLightingSettings.Brightness then
                Lighting.Brightness = savedLightingSettings.Brightness
                Lighting.ClockTime = savedLightingSettings.ClockTime
                Lighting.FogEnd = savedLightingSettings.FogEnd
                Lighting.GlobalShadows = savedLightingSettings.GlobalShadows
                Lighting.OutdoorAmbient = savedLightingSettings.OutdoorAmbient
                Lighting.Ambient = savedLightingSettings.Ambient
            end
            StarterGui:SetCore("SendNotification", {Title = "Fullbright 꺼짐", Text = "원래 밝기로 복구되었습니다.", Duration = 3})
        end

    elseif lowerMsg == ".unfullbright" or lowerMsg == ".unfb" then
        if fullbrightLoop then
            fullbrightLoop:Disconnect()
            fullbrightLoop = nil
            if savedLightingSettings.Brightness then
                Lighting.Brightness = savedLightingSettings.Brightness
                Lighting.ClockTime = savedLightingSettings.ClockTime
                Lighting.FogEnd = savedLightingSettings.FogEnd
                Lighting.GlobalShadows = savedLightingSettings.GlobalShadows
                Lighting.OutdoorAmbient = savedLightingSettings.OutdoorAmbient
                Lighting.Ambient = savedLightingSettings.Ambient
            else
                Lighting.Brightness = 1
                Lighting.GlobalShadows = true
            end
            StarterGui:SetCore("SendNotification", {Title = "Fullbright 해제", Text = "밝기를 원래대로 되돌렸습니다.", Duration = 3})
        end

    elseif lowerMsg == ".nofog" then
        Lighting.FogEnd = 1000000; Lighting.FogStart = 0
        for _, v in pairs(Lighting:GetChildren()) do if v:IsA("Atmosphere") then v:Destroy() end end
        StarterGui:SetCore("SendNotification", {Title = "안개 제거 완료", Text = "안개와 Atmosphere를 제거했습니다.", Duration = 3})

    elseif lowerMsg == ".infjump" then
        if not infJumpConnection then
            if lp.Character and lp.Character:FindFirstChild("Humanoid") then previousJumpPower = lp.Character.Humanoid.JumpPower else previousJumpPower = nil end
            infJumpConnection = UserInputService.JumpRequest:Connect(function()
                if lp.Character and lp.Character:FindFirstChild("Humanoid") then lp.Character.Humanoid:ChangeState(Enum.HumanoidStateType.Jumping) end
            end)
            StarterGui:SetCore("SendNotification", {Title = "InfJump 켜짐", Text = "공중 점프가 가능합니다.", Duration = 3})
        else StarterGui:SetCore("SendNotification", {Title = "InfJump", Text = "이미 실행 중입니다.", Duration = 3}) end

    elseif lowerMsg == ".uninfjump" then
        if infJumpConnection then
            infJumpConnection:Disconnect()
            infJumpConnection = nil
            if previousJumpPower and lp.Character and lp.Character:FindFirstChild("Humanoid") then pcall(function() lp.Character.Humanoid.JumpPower = previousJumpPower end) end
            StarterGui:SetCore("SendNotification", {Title = "InfJump 해제", Text = "무한 점프가 꺼졌습니다.", Duration = 3})
        end

    elseif lowerMsg == ".walkfling" or lowerMsg == ".wf" then
        if walkflingEnabled then return end
        walkflingEnabled = true
        toggleNoclip(true)
        StarterGui:SetCore("SendNotification", {Title = "WalkFling 활성화", Text = "WalkFling 및 Noclip이 켜졌습니다.", Duration = 3})
        task.spawn(function()
            local movel = 0.1
            while walkflingEnabled do
                RunService.Heartbeat:Wait()
                local character = lp.Character
                local root = character and character:FindFirstChild("HumanoidRootPart")
                if character and character.Parent and root and root.Parent then
                    local vel = root.Velocity
                    root.Velocity = vel * 10000 + Vector3.new(0, 10000, 0)
                    RunService.RenderStepped:Wait()
                    if not walkflingEnabled then break end
                    if character and character.Parent and root and root.Parent then root.Velocity = vel end
                    RunService.Stepped:Wait()
                    if not walkflingEnabled then break end
                    if character and character.Parent and root and root.Parent then
                        root.Velocity = vel + Vector3.new(0, movel, 0)
                        movel = movel * -1
                    end
                else RunService.Heartbeat:Wait() end
            end
        end)

    elseif lowerMsg == ".unwalkfling" or lowerMsg == ".unwf" then
        walkflingEnabled = false
        toggleNoclip(false)
        if lp.Character and lp.Character:FindFirstChild("HumanoidRootPart") then lp.Character.HumanoidRootPart.Velocity = Vector3.new(0,0,0) end
        StarterGui:SetCore("SendNotification", {Title = "WalkFling 해제", Text = "WalkFling 및 Noclip이 꺼졌습니다.", Duration = 3})

    elseif lowerMsg == ".noclip" then toggleNoclip(true); StarterGui:SetCore("SendNotification", {Title = "Noclip 활성화", Text = "벽을 통과할 수 있습니다.", Duration = 3})
    elseif lowerMsg == ".unnoclip" then toggleNoclip(false); StarterGui:SetCore("SendNotification", {Title = "Noclip 비활성화", Text = "다시 벽에 충돌합니다.", Duration = 3})
    elseif lowerMsg:sub(1, 4) == ".fly" then startFlying("fly", lowerMsg:sub(6))
    elseif lowerMsg:sub(1, 5) == ".vfly" then startFlying("vfly", lowerMsg:sub(7))
    elseif lowerMsg == ".unfly" then stopFlying()
    elseif lowerMsg == ".unvfly" then stopFlying()

    elseif lowerMsg:sub(1, 6) == ".spin " then
        local speed = tonumber(msg:sub(7))
        if speed then
            toggleSpin(true, speed)
        else
            StarterGui:SetCore("SendNotification", {Title = "사용법", Text = ".spin [숫자] - 숫자만큼 속도로 회전", Duration = 4})
        end
    elseif lowerMsg == ".unspin" then
        toggleSpin(false)

    elseif lowerMsg == ".thirdp" then
        lp.CameraMode = Enum.CameraMode.Classic
        lp.CameraMaxZoomDistance = 999
        lp.CameraMinZoomDistance = 0.5
        StarterGui:SetCore("SendNotification", {Title = "3인칭 활성화", Text = "시점 잠금 해제, 최대 줌 999", Duration = 3})

    elseif lowerMsg == ".firstp" then
        lp.CameraMode = Enum.CameraMode.LockFirstPerson
        lp.CameraMaxZoomDistance = 0.5
        StarterGui:SetCore("SendNotification", {Title = "1인칭 활성화", Text = "1인칭 시점으로 고정됩니다.", Duration = 3})

    elseif lowerMsg:sub(1, 4) == ".to " then
        local targetNamePart = lowerMsg:sub(5)
        local targetPlayer = nil
        for _, p in ipairs(Players:GetPlayers()) do
            if p ~= lp then
                local pName = p.Name:lower()
                local pDisplay = p.DisplayName:lower()
                if pName:sub(1, #targetNamePart) == targetNamePart or pDisplay:sub(1, #targetNamePart) == targetNamePart then
                    targetPlayer = p
                    break
                end
            end
        end
        if targetPlayer and targetPlayer.Character and targetPlayer.Character:FindFirstChild("HumanoidRootPart") then
            local targetHRP = targetPlayer.Character.HumanoidRootPart
            local myHRP = lp.Character and lp.Character:FindFirstChild("HumanoidRootPart")
            if myHRP then
                local offsetCFrame = CFrame.new(-5, 0, 5)
                myHRP.AssemblyLinearVelocity = Vector3.new(0, 0, 0) 
                myHRP.AssemblyAngularVelocity = Vector3.new(0, 0, 0)
                myHRP.CFrame = targetHRP.CFrame * offsetCFrame
                myHRP.Anchored = true
                StarterGui:SetCore("SendNotification", {Title = "이동 완료", Text = targetPlayer.Name .. "님에게 이동", Duration = 2})
                task.delay(0.3, function() if myHRP then myHRP.Anchored = false end end)
            end
        end

    elseif lowerMsg:sub(1, 6) == ".view " then
        local targetNamePart = lowerMsg:sub(7)
        local targetP = nil
        for _, p in ipairs(Players:GetPlayers()) do
            local pName = p.Name:lower()
            local pDisplay = p.DisplayName:lower()
            if pName:sub(1, #targetNamePart) == targetNamePart or pDisplay:sub(1, #targetNamePart) == targetNamePart then
                targetP = p
                break
            end
        end
        if targetP then
            viewingPlayer = targetP
            if viewConnection then viewConnection:Disconnect() viewConnection = nil end
            local function setView()
                local char = targetP.Character
                if char then
                    local hum = char:FindFirstChild("Humanoid")
                    if hum then
                        workspace.CurrentCamera.CameraSubject = hum
                    end
                end
            end
            setView()
            viewConnection = targetP.CharacterAdded:Connect(function(char)
                task.wait(0.2)
                local hum = char:WaitForChild("Humanoid", 5)
                if hum then
                    workspace.CurrentCamera.CameraSubject = hum
                end
            end)
            StarterGui:SetCore("SendNotification", {Title = "관전 모드", Text = targetP.Name .. "님을 관전합니다 (자동 추적).", Duration = 3})
        end

    elseif lowerMsg == ".unview" then
        if viewConnection then viewConnection:Disconnect() viewConnection = nil end
        viewingPlayer = nil
        if lp.Character and lp.Character:FindFirstChild("Humanoid") then
            workspace.CurrentCamera.CameraSubject = lp.Character.Humanoid
            StarterGui:SetCore("SendNotification", {Title = "관전 종료", Text = "본인 시점으로 돌아왔습니다.", Duration = 3})
        end

    elseif lowerMsg == ".spawn" then
        if lp.Character and lp.Character:FindFirstChild("HumanoidRootPart") then
            customSpawnCFrame = lp.Character.HumanoidRootPart.CFrame
            if spawnConnection then spawnConnection:Disconnect() end
            spawnConnection = lp.CharacterAdded:Connect(function(char)
                local hrp = char:WaitForChild("HumanoidRootPart", 10)
                if hrp and customSpawnCFrame then 
                    local forceTime = 0.5
                    local sTime = tick()
                    local conn
                    conn = RunService.Heartbeat:Connect(function()
                        if tick() - sTime > forceTime then conn:Disconnect()
                        elseif hrp then hrp.CFrame = customSpawnCFrame hrp.Velocity = Vector3.new(0,0,0) end
                    end)
                end
            end)
            StarterGui:SetCore("SendNotification", {Title = "스폰 설정 완료", Text = "즉시 스폰으로 저장되었습니다.", Duration = 3})
        end
    elseif lowerMsg == ".delspawn" then
        if spawnConnection then spawnConnection:Disconnect() spawnConnection = nil end
        customSpawnCFrame = nil
        StarterGui:SetCore("SendNotification", {Title = "스폰 삭제 완료", Text = "기본 스폰으로 초기화되었습니다.", Duration = 3})

    elseif lowerMsg == ".dex" then
        pcall(function() loadstring(game:HttpGet("https://raw.githubusercontent.com/infyiff/backup/main/dex.lua"))() end)
        StarterGui:SetCore("SendNotification", {Title = "Dex 실행", Text = "Dex Explorer 로딩 중...", Duration = 3})

    elseif lowerMsg == ".rspy" then
        pcall(function() loadstring(game:HttpGet("https://raw.githubusercontent.com/78n/SimpleSpy/main/SimpleSpySource.lua"))() end)
        StarterGui:SetCore("SendNotification", {Title = "SimpleSpy 실행", Text = "Remote Spy가 실행되었습니다.", Duration = 3})

    elseif lowerMsg == ".lg" then
        pcall(function() loadstring(game:HttpGet("https://raw.githubusercontent.com/dosi1100-cmyk/script/refs/heads/main/Loopgrab"))() end)
    elseif lowerMsg == ".unlg" then
        pcall(function() loadstring(game:HttpGet("https://raw.githubusercontent.com/dosi1100-cmyk/script/refs/heads/main/Loopgrab"))() end)

    elseif lowerMsg:sub(1, 8) == ".pendik " then
        local args = {}
        for w in string.gmatch(msg:sub(9), "%S+") do
            table.insert(args, w)
        end

        local targetPlayer = lp
        local TNUM = nil

        if #args == 1 then
            local num = tonumber(args[1])
            if num then
                TNUM = num
                targetPlayer = lp
            else
                StarterGui:SetCore("SendNotification", {Title = "오류", Text = "숫자를 입력해주세요. 예: .pendik 10", Duration = 3})
                return
            end
        elseif #args >= 2 then
            local namePart = args[1]
            local num = tonumber(args[2])
            if not num then
                StarterGui:SetCore("SendNotification", {Title = "오류", Text = "올바른 숫자를 입력하세요. 예: .pendik mir 10", Duration = 3})
                return
            end
            TNUM = num
            
            local found = nil
            for _, p in ipairs(Players:GetPlayers()) do
                if p.Name:lower():sub(1, #namePart) == namePart:lower() or p.DisplayName:lower():sub(1, #namePart) == namePart:lower() then
                    found = p
                    break
                end
            end
            if found then
                targetPlayer = found
            else
                StarterGui:SetCore("SendNotification", {Title = "오류", Text = "플레이어를 찾을 수 없습니다: " .. namePart, Duration = 3})
                return
            end
        end

        if not TNUM or TNUM <= 0 then return end

        StarterGui:SetCore("SendNotification", {Title = "Pendik 실행", Text = targetPlayer.DisplayName .. "님에게 " .. TNUM .. "개 생성 시작...", Duration = 3})
        
        task.spawn(function()
            local ReplicatedStorage = game:GetService("ReplicatedStorage")
            local StickyPartEvent = ReplicatedStorage:WaitForChild("PlayerEvents"):WaitForChild("StickyPartEvent")
            local SpawnToy = ReplicatedStorage:WaitForChild("MenuToys"):WaitForChild("SpawnToyRemoteFunction")
            local plr = lp 

            -- [수정됨] 타겟(최종 부착 대상) 정보 가져오기
            local targetChar = targetPlayer.Character or targetPlayer.CharacterAdded:Wait()
            local targetTorso = targetChar:WaitForChild("HumanoidRootPart"):WaitForChild("RagdollTouchedHitbox")

            -- [수정됨] 스폰 위치 기준: 내 캐릭터(LocalPlayer)
            local myChar = lp.Character or lp.CharacterAdded:Wait()
            local myHRP = myChar:WaitForChild("HumanoidRootPart", 5)

            if not myHRP then 
                warn("내 캐릭터 HRP를 찾을 수 없음") 
                return 
            end

            local function GetPlotNumber()
                local char = lp.Character 
                if not char then return nil end

                if char.Parent == workspace then 
                    return nil
                elseif char.Parent.Name == "PlayersInPlots" then
                    for _, plot in workspace.Plots:GetChildren() do
                        for _, owner in plot.PlotSign.ThisPlotsOwners:GetChildren() do
                            if owner.Value == plr.Name then
                                if plot.Name == "Plot1" then
                                    return 1
                                elseif plot.Name == "Plot2" then
                                    return 2
                                elseif plot.Name == "Plot3" then
                                    return 3
                                elseif plot.Name == "Plot4" then
                                    return 4
                                elseif plot.Name == "Plot5" then
                                    return 5
                                end
                            end
                        end
                    end
                end
                return nil
            end

            local function GetInventory()
                local plotNumber = GetPlotNumber()

                if plotNumber then
                    local plotItems = workspace:FindFirstChild("PlotItems")
                    if plotItems then
                        local plotFolder = plotItems:FindFirstChild("Plot" .. plotNumber)
                        if plotFolder then
                            return plotFolder
                        end
                    end
                end
                return workspace:WaitForChild(plr.Name .. "SpawnedInToys")
            end

            local inv = GetInventory()

            local function createPencil(index)
                while not plr.CanSpawnToy.Value do task.wait() end

                task.spawn(function()
                    -- [수정됨] 타겟이 누구든 무조건 내(LocalPlayer) 앞에서 스폰
                    SpawnToy:InvokeServer("ToolPencil", myHRP.CFrame * CFrame.new(0,5,15), Vector3.new(0,0,0))
                end)

                task.wait(0.3)

                inv = GetInventory()

                local pencil
                local children = inv:GetChildren()
                for i = #children, 1, -1 do
                    if children[i].Name == "ToolPencil" then
                        pencil = children[i]
                        break
                    end
                end

                if not pencil then 
                    print("Pencil not found in inventory")
                    return nil 
                end

                local stickyPart = pencil:WaitForChild("StickyPart")
                local SoundPart = pencil:WaitForChild("SoundPart")

                if stickyPart and SoundPart then
                    ReplicatedStorage.GrabEvents.SetNetworkOwner:FireServer(SoundPart, SoundPart.CFrame)
                    -- [수정됨] 소유권은 일단 내 주변에 있으므로 내 HRP 기준 설정
                    ReplicatedStorage.GrabEvents.SetNetworkOwner:FireServer(SoundPart, myHRP.CFrame)
                end

                local PartOwner = SoundPart:WaitForChild("PartOwner")
                if PartOwner then
                    SoundPart.CFrame = CFrame.new(0, 599999, 999)
                end

                stickyPart.Name = "w" .. index

                for _, part in pairs(pencil:GetDescendants()) do
                    if part:IsA("BasePart") and part.Color == Color3.fromRGB(158, 108, 141) then
                        part.Name = "a" .. index
                    end
                end

                return pencil
            end

            local pencils = {}

            -- [1단계] 내 앞에서 연필 생성 및 목록 저장
            for i = 1, TNUM do
                local pencil = createPencil(i)
                if pencil then
                    table.insert(pencils, pencil)
                end
                task.wait(0.1)
            end

            -- [2단계] 생성된 연필끼리 서로 부착 (내 앞에서 진행됨)
            for i = 1, #pencils - 1 do
                local currentPencil = pencils[i]
                local nextPencil = pencils[i + 1]

                if currentPencil and nextPencil then
                    local attachFrom = currentPencil:FindFirstChild("w" .. i)
                    local attachTo = nextPencil:FindFirstChild("a" .. (i + 1))

                    if attachFrom and attachTo then
                        StickyPartEvent:FireServer(attachFrom, attachTo, CFrame.Angles(0, math.rad(-90), 0))
                    end
                end
                task.wait(0.05)
            end

            -- [3단계] 최종 완성품을 타겟 플레이어에게 부착 (원격 부착)
            -- 내 앞에 있는 마지막 연필(wLast)을 저 멀리 있는 타겟(targetTorso)에 부착시킴
            if targetTorso and #pencils >= TNUM then
                local lastPencil = pencils[TNUM]
                if lastPencil then
                    local wLast = lastPencil:FindFirstChild("w" .. TNUM)
                    if wLast then
                        local attachPosition = targetTorso.CFrame * CFrame.new(0, -1.1, 0.1) * CFrame.Angles(0, math.rad(180), 0)
                        local relativeCF = targetTorso.CFrame:ToObjectSpace(attachPosition)
                        StickyPartEvent:FireServer(wLast, targetTorso, relativeCF)
                    end
                end
            end
        end)
    
    elseif lowerMsg == ".exit" or lowerMsg == ".run" then game:Shutdown()

    elseif lowerMsg == ".종료" or lowerMsg == ".end" then
        StarterGui:SetCore("SendNotification", { Title = "스크립트 종료", Text = "열려있는 모든 GUI를 닫고 스크립트를 완벽하게 종료합니다.", Duration = 4 })
        
        if chatConnection then chatConnection:Disconnect() chatConnection = nil end
        if mainInputConnection then mainInputConnection:Disconnect() mainInputConnection = nil end
        
        toggleAntiLag(false)
        toggleDelLines(false)
        toggleFpsBoost(false) 
        antiAfkEnabled = false
        stopFlying()
        toggleNoclip(false)
        walkflingEnabled = false
        toggleSpin(false)
        togglePlcd(false) 
        toggleAutoReset(false) 
        toggleTakeFood(false)  
        toggleAntiBomb(false) 
        toggleAntiInPlots(false) 
        toggleAntiBarrier(false) 
        toggleOceanWalk(false) 
        stopTpwalk()
        toggleIconEsp(false)
        
        if spawnConnection then spawnConnection:Disconnect() spawnConnection = nil end
        if fullbrightLoop then fullbrightLoop:Disconnect() fullbrightLoop = nil end
        if antiAfkConnection then antiAfkConnection:Disconnect() antiAfkConnection = nil end
        if infJumpConnection then infJumpConnection:Disconnect() infJumpConnection = nil end
        if loopSpeedConnection then loopSpeedConnection:Disconnect() loopSpeedConnection = nil end
        if loopJumpConnection then loopJumpConnection:Disconnect() loopJumpConnection = nil end
        if viewConnection then viewConnection:Disconnect() viewConnection = nil end
        
        viewingPlayer = nil
        lp.CameraMode = defaultCameraMode
        lp.CameraMinZoomDistance = defaultMinZoom
        lp.CameraMaxZoomDistance = defaultMaxZoom
        workspace.CurrentCamera.FieldOfView = defaultFOV
        
        -- [캐시 초기화]
        friendCache = {}

        if lp.Character and lp.Character:FindFirstChild("Humanoid") then 
            workspace.CurrentCamera.CameraSubject = lp.Character.Humanoid 
        end
        
        local guisToDestroy = {
            serverInfoGui, helpGuiGlobal, helpFrame, friendAlertGui, friendListGui
        }
        for _, gui in ipairs(guisToDestroy) do
            if gui then pcall(function() gui:Destroy() end) end
        end
        serverInfoGui, helpGuiGlobal, helpFrame, friendAlertGui, friendListGui = nil, nil, nil, nil, nil

        local cmdGui = lp.PlayerGui:FindFirstChild("CmdBarGui")
        if cmdGui then cmdGui:Destroy() end
        
        for _, gui in ipairs(lp.PlayerGui:GetChildren()) do
            if gui:IsA("ScreenGui") and (
                gui.Name == "ServerInfoGui" or gui.Name == "HelpGui" or 
                gui.Name == "CmdBarGui" or gui.Name == "FriendNotification" or 
                gui.Name == "FriendListGui" or gui.Name == "PingNotification" or 
                gui.Name == "FriendAlerts"
            ) then
                pcall(function() gui:Destroy() end)
            end
        end
        
        print("스크립트가 완전히 정상적으로 종료되었습니다.")
        return
    end
end

-- [도움말 GUI]
local function createHelpGui()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "HelpGui"
    screenGui.Parent = lp:WaitForChild("PlayerGui")
    screenGui.ResetOnSpawn = false
    screenGui.DisplayOrder = 999999999
    screenGui.IgnoreGuiInset = true

    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(0, 360, 0, 500)
    frame.Position = UDim2.new(1, -390, 0.5, -250)
    frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    frame.BorderSizePixel = 0
    frame.Visible = false
    frame.Parent = screenGui
    makeDraggable(frame)
    local corner = Instance.new("UICorner"); corner.CornerRadius = UDim.new(0, 10); corner.Parent = frame
    local title = Instance.new("TextLabel")
    title.Size = UDim2.new(1, 0, 0, 40)
    title.Text = "명령어 목록"
    title.TextColor3 = Color3.new(1, 1, 1)
    title.BackgroundTransparency = 1
    title.Font = Enum.Font.GothamBold
    title.TextSize = 18
    title.Parent = frame

    local scrollFrame = Instance.new("ScrollingFrame")
    scrollFrame.Size = UDim2.new(1, -20, 1, -60)
    scrollFrame.Position = UDim2.new(0, 10, 0, 50)
    scrollFrame.BackgroundTransparency = 1
    scrollFrame.BorderSizePixel = 0
    scrollFrame.ScrollBarThickness = 8
    scrollFrame.AutomaticCanvasSize = Enum.AutomaticSize.None
    scrollFrame.CanvasSize = UDim2.new(0,0,0,0)
    scrollFrame.Parent = frame
    local content = Instance.new("Frame")
    content.Name = "Content"
    content.Size = UDim2.new(1, -10, 0, 0)
    content.Position = UDim2.new(0, 5, 0, 0)
    content.BackgroundTransparency = 1
    content.BorderSizePixel = 0
    content.AutomaticSize = Enum.AutomaticSize.Y
    content.Parent = scrollFrame
    local listLayout = Instance.new("UIListLayout")
    listLayout.Parent = content
    listLayout.SortOrder = Enum.SortOrder.LayoutOrder
    listLayout.Padding = UDim.new(0, 6)

    local helpText = [[• ; 키를 눌러 커맨드바 실행 가능
• 커맨드바에서 /내용 입력 시 채팅 전송
• 채팅창에서는 반드시 . 을 붙여야 함

---- [ 최적화 & 성능 ] ----
• .fpsboost / .fps : FPS 부스트 (최적화)
• .unfpsboost / .unfps : 최적화 해제 (복구)
• .antilag : 렉 걸리면 자동 종료 (FPS<8, 수신>2000kb)
• .unantilag : 자동 종료 해제
• .fullbright / .fb : 맵 아주 밝게
• .unfb : 맵 밝기 복구
• .nofog : 안개 제거

---- [ 채팅 & 서버 ] ----
• .chat / .say [내용] : 채팅 말하기
• .svhop : 다른 서버로 이동 (서버 홉)
• .재접 / .rj : 서버 재접속
• .렉 / .lag : 서버 렉 실행
• .핑 : 현재 핑 확인
• .친구 / .fl : 친구 목록 GUI (화면 왼쪽, 스크롤 가능)
• .서버 정보 : 서버 정보 GUI 표시
• .jobid : 현재 서버 Job ID 복사

---- [ 캐릭터 설정 ] ----
• .speed [숫자] : 속도 변경 (리셋됨)
• .loopspeed [숫자] : 속도 강제 고정
• .unloopspeed : 속도 고정 해제
• .fov [숫자] : 카메라 시야각(FOV) 변경
• .jpp / .jumppower [숫자] : 점프력 변경
• .loopjpp [숫자] : 점프력 강제 고정
• .unloopjpp : 점프력 고정 해제
• .unjpp : 점프력 초기화 (고정은 유지됨)
• .reset / .die : 캐릭터 확실히 죽기
• .infjump : 무한 점프 토글
• .uninfjump : 무한 점프 해제
• .noclip : 벽 통과 켜기
• .unnoclip : 벽 통과 끄기
• .antiafk : 잠수 방지 켜기 (20분 킥 방지)
• .unantiafk : 잠수 방지 끄기

---- [ 이동 & 관전 & ESP ] ----
• .tpwalk [속도] : 텔레포트 걸음
• .untpwalk : tpwalk 끄기
• .iconesp / .ie : 1000 Studs 이내 프로필 ESP
• .uniconesp / .unie : ESP 끄기
• .walkfling / .wf : 걸어서 날리기(Noclip 켜짐)
• .unwalkfling / .unwf : 걸어서 날리기 끄기
• .fly [속도] : 일반 날기 (Velocity 방식)
• .unfly : 일반 날기 해제
• .vfly [속도] : 차량과 함께 날기 (Velocity 방식)
• .unvfly : 차량 날기 해제
• .spin [속도] : 캐릭터 회전 (숫자만큼 속도로 회전)
• .unspin : 회전 멈춤
• .to [이름] : 대상에게 이동
• .join [이름] : 친구 게임 서버 참가(같은 게임)
• .view [이름] : 3인칭 관전 모드
• .unview : 관전 해제
• .thirdp : 3인칭 모드 (Zoom 999)
• .firstp : 1인칭 고정 모드
• .spawn : 현재 위치 스폰 지정
• .delspawn : 스폰 지정 삭제

---- [ 아이템 & 기타 ] ----
• .age [이름] : 계정 생성일 및 나이 확인
• .dex : Dex Explorer 실행
• .rspy : SimpleSpy V3 실행
• .exit : 게임 종료
• .종료 / .end : 스크립트 종료

---- [ FTAP 관련 ] ----
• .dellines / .dl : CharacterAndBeamMove 비활성화 (렉 감소)
• .undellines / .undl : CharacterAndBeamMove 활성화
• .showplcd / .plcd : 감지기 파트 빨간색 테두리 표시 (벽뒤 숨김)
• .hideplcd / .unplcd : 감지기 파트 표시 끄기
• .delplcd / .breakplcd : PLCD 삭제(AutoReset) 켜기
• .undeleteplcd / .unbreakplcd : PLCD 삭제 끄기
• .lg : 룹그랩 시작 (룹그랩 시작)
• .unlg : 룹그랩 종료 (룹그랩 종료)
• .kg : 킥그랩 시작 (킥그랩 시작)
• .unkg : 킥그랩 종료 (킥그랩 종료)
• .antibomb / .ab : 안티 폭탄 켜기 (오븐 설치 및 자동 공격)
• .unantibomb / .unab : 안티 폭탄 끄기 (오븐 삭제)
• .antiinplots / .aip : 집 내부 플레이어 잡기
• .unantiinplots / .unaip : 납치 기능 끄기
• .breakbarrier : 배리어 부수기 켜기 (L키 작동)
• .unbreakbarrier : 배리어 부수기 끄기
• .takefood / .tf : 음식 뺏어가기 켜기 (내부 스크립트 실행)
• .untakefood / .untf : 음식 뺏어가기 끄기 (즉시 정지)
• .antibarrier / .barrier : 플롯 장벽 통과 (기본값 ON)
• .unantibarrier / .unbarrier : 플롯 장벽 복구
• .oceanwalk : 바다 위 걷기
• .unoceanwalk / .unow : 바다 위 걷기 끄기
• .pendik [숫자] : 나에게 작동
• .pendik [이름] [숫자] : 해당 유저에게 작동
]]

    for line in helpText:gmatch("[^\n]+") do
        local lbl = Instance.new("TextLabel")
        lbl.Size = UDim2.new(1, 0, 0, 0)
        lbl.BackgroundTransparency = 1
        lbl.Font = Enum.Font.Gotham
        lbl.TextSize = 14
        lbl.TextColor3 = Color3.fromRGB(220,220,220)
        lbl.TextXAlignment = Enum.TextXAlignment.Left
        lbl.TextYAlignment = Enum.TextYAlignment.Top
        lbl.TextWrapped = true
        lbl.AutomaticSize = Enum.AutomaticSize.Y
        lbl.Text = line
        lbl.Parent = content
    end

    local function updateCanvasSize()
        local contentHeight = listLayout.AbsoluteContentSize and listLayout.AbsoluteContentSize.Y or 0
        scrollFrame.CanvasSize = UDim2.new(0, 0, 0, math.ceil(contentHeight + 12))
    end
    task.delay(0.03, updateCanvasSize)
    listLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(updateCanvasSize)
    content:GetPropertyChangedSignal("AbsoluteSize"):Connect(updateCanvasSize)

    local closeBtn = Instance.new("TextButton")
    closeBtn.Size = UDim2.new(0, 30, 0, 30)
    closeBtn.Position = UDim2.new(1, -35, 0, 5)
    closeBtn.Text = "X"
    closeBtn.TextColor3 = Color3.new(1, 1, 1)
    closeBtn.BackgroundColor3 = Color3.fromRGB(220, 60, 60)
    closeBtn.Font = Enum.Font.GothamBold
    closeBtn.Parent = frame
    local btnCorner = Instance.new("UICorner"); btnCorner.CornerRadius = UDim.new(0, 5); btnCorner.Parent = closeBtn
    closeBtn.MouseButton1Click:Connect(function() frame.Visible = false end)
    return frame, screenGui
end

-- [서버 정보 GUI]
function createServerInfoGui()
    if serverInfoGui and serverInfoGui.Parent then serverInfoGui.Enabled = not serverInfoGui.Enabled return end
    serverInfoGui = Instance.new("ScreenGui")
    serverInfoGui.Name = "ServerInfoGui"
    serverInfoGui.Parent = lp:WaitForChild("PlayerGui")
    serverInfoGui.ResetOnSpawn = false
    serverInfoGui.DisplayOrder = 999999995

    local mainFrame = Instance.new("Frame")
    mainFrame.Size = UDim2.new(0, 420, 0, 220)
    mainFrame.Position = UDim2.new(0.55, -210, 0.5, -110)
    mainFrame.BackgroundColor3 = Color3.fromRGB(18, 18, 18)
    mainFrame.BorderSizePixel = 0
    mainFrame.Parent = serverInfoGui
    makeDraggable(mainFrame)
    local mainCorner = Instance.new("UICorner"); mainCorner.CornerRadius = UDim.new(0, 12); mainCorner.Parent = mainFrame

    local header = Instance.new("Frame")
    header.Size = UDim2.new(1, 0, 0, 40)
    header.BackgroundTransparency = 1
    header.Parent = mainFrame
    local title = Instance.new("TextLabel")
    title.Size = UDim2.new(1, -20, 0, 36)
    title.Position = UDim2.new(0, 10, 0, 2)
    title.BackgroundTransparency = 1
    title.Text = "서버 정보"
    title.Font = Enum.Font.GothamBold
    title.TextSize = 20
    title.TextColor3 = Color3.fromRGB(255, 255, 255)
    title.Parent = header
    local sep = Instance.new("Frame")
    sep.Size = UDim2.new(1, -20, 0, 1)
    sep.Position = UDim2.new(0, 10, 0, 42)
    sep.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
    sep.BorderSizePixel = 0
    sep.Parent = mainFrame

    local playersCurrentLabel = Instance.new("TextLabel")
    playersCurrentLabel.Size = UDim2.new(0.5, -15, 0, 24)
    playersCurrentLabel.Position = UDim2.new(0.5, 3, 0, 52)
    playersCurrentLabel.BackgroundTransparency = 1
    playersCurrentLabel.Font = Enum.Font.Gotham
    playersCurrentLabel.TextSize = 15
    playersCurrentLabel.TextColor3 = Color3.fromRGB(230, 230, 230)
    playersCurrentLabel.TextXAlignment = Enum.TextXAlignment.Left
    playersCurrentLabel.Text = "현재 인원: " .. tostring(#Players:GetPlayers())
    playersCurrentLabel.Parent = mainFrame

    local playersMaxLabel = Instance.new("TextLabel")
    playersMaxLabel.Size = UDim2.new(0.5, -15, 0, 24)
    playersMaxLabel.Position = UDim2.new(0, 12, 0, 52)
    playersMaxLabel.BackgroundTransparency = 1
    playersMaxLabel.Font = Enum.Font.Gotham
    playersMaxLabel.TextSize = 15
    playersMaxLabel.TextColor3 = Color3.fromRGB(230, 230, 230)
    playersMaxLabel.TextXAlignment = Enum.TextXAlignment.Left
    playersMaxLabel.Text = "서버 최대 인원: " .. tostring(Players.MaxPlayers)
    playersMaxLabel.Parent = mainFrame

    local function createRow(yOffset, labelText, valueText)
        local leftLabel = Instance.new("TextLabel")
        leftLabel.Size = UDim2.new(0.45, -10, 0, 26)
        leftLabel.Position = UDim2.new(0, 12, 0, yOffset)
        leftLabel.BackgroundTransparency = 1
        leftLabel.Font = Enum.Font.Gotham
        leftLabel.TextSize = 14
        leftLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
        leftLabel.TextXAlignment = Enum.TextXAlignment.Left
        leftLabel.Text = labelText
        leftLabel.Parent = mainFrame
        local valueLabel = Instance.new("TextLabel")
        valueLabel.Size = UDim2.new(0.35, -10, 0, 26)
        valueLabel.Position = UDim2.new(0.45, 0, 0, yOffset)
        valueLabel.BackgroundTransparency = 1
        valueLabel.Font = Enum.Font.Gotham
        valueLabel.TextSize = 14
        valueLabel.TextColor3 = Color3.fromRGB(230, 230, 230)
        valueLabel.TextXAlignment = Enum.TextXAlignment.Left
        valueLabel.Text = valueText
        valueLabel.Parent = mainFrame
        local copyBtn = Instance.new("TextButton")
        copyBtn.Size = UDim2.new(0.15, -10, 0, 24)
        copyBtn.Position = UDim2.new(0.8, 0, 0, yOffset)
        copyBtn.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
        copyBtn.BorderSizePixel = 0
        copyBtn.Font = Enum.Font.Gotham
        copyBtn.TextSize = 13
        copyBtn.TextColor3 = Color3.fromRGB(255,255,255)
        copyBtn.Text = "Copy"
        copyBtn.AutoButtonColor = true
        copyBtn.Parent = mainFrame
        local btnCorner = Instance.new("UICorner"); btnCorner.CornerRadius = UDim.new(0, 6); btnCorner.Parent = copyBtn
        return leftLabel, valueLabel, copyBtn
    end
    local _, _, placeCopy = createRow(86, "Place id:", tostring(game.PlaceId))
    placeCopy.MouseButton1Click:Connect(function() pcall(function() setclipboard(tostring(game.PlaceId)) end) StarterGui:SetCore("SendNotification", {Title = "복사됨", Text = "Place id가 복사되었습니다.", Duration = 2}) end)
    local _, _, jobCopy = createRow(116, "Job id:", tostring(game.JobId))
    jobCopy.MouseButton1Click:Connect(function() pcall(function() setclipboard(tostring(game.JobId)) end) StarterGui:SetCore("SendNotification", {Title = "복사됨", Text = "Job id가 복사되었습니다.", Duration = 2}) end)
    local success, gameInfo = pcall(function() return MarketplaceService:GetProductInfo(game.PlaceId) end)
    local gameNameStr = "Unknown"
    if success and gameInfo and type(gameInfo.Name) == "string" then gameNameStr = gameInfo.Name else if game.PlaceId and tostring(game.PlaceId) ~= "" then gameNameStr = "Place " .. tostring(game.PlaceId) end end
    local _, _, nameCopy = createRow(146, "Game Name:", gameNameStr)
    nameCopy.MouseButton1Click:Connect(function() pcall(function() setclipboard(tostring(gameNameStr)) end) StarterGui:SetCore("SendNotification", {Title = "복사됨", Text = "GameName이 복사되었습니다.", Duration = 2}) end)

    local uptimeLabel = Instance.new("TextLabel")
    uptimeLabel.Size = UDim2.new(1, -20, 0, 20)
    uptimeLabel.Position = UDim2.new(0, 10, 0, 176)
    uptimeLabel.BackgroundTransparency = 1
    uptimeLabel.Font = Enum.Font.Gotham
    uptimeLabel.TextSize = 13
    uptimeLabel.TextColor3 = Color3.fromRGB(200,200,200)
    uptimeLabel.TextXAlignment = Enum.TextXAlignment.Left
    uptimeLabel.Text = "업타임: 0초"
    uptimeLabel.Parent = mainFrame

    local lastUpdate = 0
    local updateConn
    updateConn = RunService.Heartbeat:Connect(function(dt)
        lastUpdate = lastUpdate + dt
        if lastUpdate < 0.5 then return end
        lastUpdate = 0
        if not mainFrame or not mainFrame.Parent then if updateConn then updateConn:Disconnect() updateConn = nil end return end
        playersCurrentLabel.Text = "현재 인원: " .. tostring(#Players:GetPlayers())
        local elapsed = math.floor(tick() - startTime)
        local h = math.floor(elapsed / 3600); local m = math.floor((elapsed % 3600) / 60); local s = elapsed % 60
        uptimeLabel.Text = string.format("업타임: %02d:%02d:%02d", h, m, s)
    end)
    return mainFrame
end

-- showFriendAlert (수정됨: v8.2 오른쪽 중앙, 검정 배경, 흰 글씨, 색상 테두리)
local function showFriendAlert(text, kind)
    if not friendAlertGui or not friendAlertGui.Parent then
        friendAlertGui = Instance.new("ScreenGui")
        friendAlertGui.Name = "FriendAlerts"
        friendAlertGui.Parent = lp:WaitForChild("PlayerGui")
        friendAlertGui.ResetOnSpawn = false
        friendAlertGui.DisplayOrder = 999999999
    end

    kind = tostring(kind or ""):lower()
    local alertWidth = 300
    local alertHeight = 60
    
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(0, alertWidth, 0, alertHeight)
    
    -- 초기 위치: 화면 오른쪽 바깥 (숨김 상태)
    frame.Position = UDim2.new(1, 20, 0.5, 0)
    frame.AnchorPoint = Vector2.new(1, 0.5) -- 오른쪽 기준 정렬
    
    frame.BackgroundColor3 = Color3.fromRGB(0, 0, 0) -- 검은색 배경
    frame.BackgroundTransparency = 0.2
    frame.BorderSizePixel = 0
    frame.Parent = friendAlertGui
    
    -- 둥근 모서리
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 10)
    corner.Parent = frame

    -- 테두리 (UIStroke)
    local stroke = Instance.new("UIStroke")
    stroke.Parent = frame
    stroke.LineJoinMode = Enum.LineJoinMode.Round
    stroke.Thickness = 3
    
    -- 테두리 색상 설정
    if kind == "join" then 
        stroke.Color = Color3.fromRGB(50, 255, 50) -- 들어올 때 초록색
    elseif kind == "leave" then 
        stroke.Color = Color3.fromRGB(255, 50, 50) -- 나갈 때 빨간색
    else 
        stroke.Color = Color3.fromRGB(255, 255, 255) 
    end

    -- 텍스트 설정
    local lbl = Instance.new("TextLabel")
    lbl.Size = UDim2.new(1, -30, 1, 0)
    lbl.Position = UDim2.new(0, 15, 0, 0)
    lbl.BackgroundTransparency = 1
    lbl.TextColor3 = Color3.fromRGB(255, 255, 255) -- 흰색 글자
    lbl.Font = Enum.Font.GothamBold
    lbl.TextSize = 16
    lbl.TextXAlignment = Enum.TextXAlignment.Center
    lbl.TextYAlignment = Enum.TextYAlignment.Center
    lbl.TextWrapped = true
    lbl.Text = text
    lbl.Parent = frame

    -- 애니메이션 위치 계산 (쌓임 처리)
    local offsetIndex = #activeAlerts
    local offsetY = (offsetIndex * (alertHeight + 10)) -- 간격 10
    
    local visiblePos = UDim2.new(1, -20, 0.5, -offsetY) -- 보이는 위치 (오른쪽에서 20px 띄움)
    local hiddenPos = UDim2.new(1, alertWidth + 50, 0.5, -offsetY) -- 숨겨질 위치

    -- 등장 애니메이션
    local ti = TweenInfo.new(0.5, Enum.EasingStyle.Quart, Enum.EasingDirection.Out)
    TweenService:Create(frame, ti, {Position = visiblePos}):Play()
    
    table.insert(activeAlerts, frame)

    -- 퇴장 애니메이션 예약
    task.spawn(function()
        task.wait(4)
        local out = TweenService:Create(frame, ti, {Position = hiddenPos})
        out:Play()
        out.Completed:Wait()
        for i,v in ipairs(activeAlerts) do 
            if v == frame then table.remove(activeAlerts, i) break end 
        end
        pcall(function() frame:Destroy() end)
    end)
end

-- [커맨드 바 생성 함수]
local function createCmdBar()
    local gui = Instance.new("ScreenGui")
    gui.Name = "CmdBarGui"
    gui.Parent = lp:WaitForChild("PlayerGui")
    gui.ResetOnSpawn = false
    gui.DisplayOrder = 999999998
    local bg = Instance.new("Frame")
    bg.Size = UDim2.new(0, 520, 0, 40)
    local hidePos = UDim2.new(0.5, -260, 1, 60)
    local showPos = UDim2.new(0.5, -260, 0.84, 0)
    bg.Position = hidePos
    bg.BackgroundColor3 = Color3.fromRGB(28,28,28)
    bg.BorderSizePixel = 0
    bg.Visible = false
    bg.Parent = gui
    local corner = Instance.new("UICorner"); corner.CornerRadius = UDim.new(0, 8); corner.Parent = bg

    local input = Instance.new("TextBox")
    input.Name = "CmdInput"
    input.Size = UDim2.new(1, -20, 1, -10)
    input.Position = UDim2.new(0, 10, 0, 5)
    input.BackgroundTransparency = 1
    input.Text = ""
    input.ClearTextOnFocus = false
    input.PlaceholderText = "명령어 입력 (엔터로 실행)"
    input.TextColor3 = Color3.fromRGB(240,240,240)
    input.Font = Enum.Font.Gotham
    input.TextSize = 16
    input.Parent = bg

    local function showBar()
        bg.Visible = true
        pcall(function() TweenService:Create(bg, TweenInfo.new(0.22, Enum.EasingStyle.Sine, Enum.EasingDirection.Out), {Position = showPos}):Play() end)
    end
    local function hideBar()
        pcall(function()
            local tw = TweenService:Create(bg, TweenInfo.new(0.22, Enum.EasingStyle.Sine, Enum.EasingDirection.In), {Position = hidePos})
            tw:Play(); tw.Completed:Wait()
        end)
        bg.Visible = false; input.Text = ""
    end

    input.Focused:Connect(function() cmdFocused = true end)
    input.FocusLost:Connect(function(enterPressed)
        local txt = tostring(input.Text or "")
        cmdFocused = false
        if enterPressed and #txt > 0 then
            if txt:sub(1,1) == "/" then sendChatMessage(txt:sub(2))
            else
                if txt:sub(1,1) ~= "." then txt = "." .. txt end
                processCommand(txt)
            end
        end
        hideBar()
    end)
    return bg, input, showBar, hideBar
end

-- ==============================================================================
-- [ v8.4 수정: 친구 감지 로직 강화 (캐시 시스템 도입) ]
-- ==============================================================================

-- [캐시 업데이트 함수]
local function updateFriendStatus(player)
    local success, isFriend = pcall(function()
        return lp:IsFriendsWith(player.UserId)
    end)
    if success and isFriend then
        friendCache[player.UserId] = true
    end
end

-- [스크립트 시작 시 현재 접속자 캐시 초기화 (알림 없음, 기억만 함)]
task.spawn(function()
    for _, p in pairs(Players:GetPlayers()) do
        if p ~= lp then
            updateFriendStatus(p)
        end
    end
    updateFriendList() 
end)

-- [이벤트 감지: 친구가 접속했을 때]
Players.PlayerAdded:Connect(function(player)
    -- 데이터 로딩 대기 (1초)
    task.wait(1) 
    
    local success, isFriend = pcall(function()
        return lp:IsFriendsWith(player.UserId)
    end)

    if success and isFriend then
        friendCache[player.UserId] = true -- 캐시에 저장
        showFriendAlert(player.DisplayName .. "님이 서버에 접속했습니다!", "join")
        updateFriendList()
    end
end)

-- [이벤트 감지: 친구가 나갔을 때 (캐시 기반 확인)]
Players.PlayerRemoving:Connect(function(player)
    -- API 호출 대신 캐시를 확인하여 100% 감지
    if friendCache[player.UserId] then
        showFriendAlert(player.DisplayName .. "님이 서버에서 나갔습니다.", "leave")
        friendCache[player.UserId] = nil -- 캐시에서 제거
        updateFriendList()
    end
end)


local helpFrameGlobal, helpGuiGlobal = createHelpGui()
helpFrame = helpFrameGlobal
local cmdFrame, cmdInput, cmdShow, cmdHide = createCmdBar()

local targetPlaceId = 6961824067

if antiLagEnabled then
    task.spawn(function()
        local delayTime = (game.PlaceId == targetPlaceId) and 5 or 10
        task.wait(delayTime)
        
        if antiLagEnabled then 
            toggleAntiLag(true)
        end
    end)
end

if game.PlaceId == targetPlaceId then
    task.spawn(function()
        task.wait(3)
        toggleAntiBarrier(true) 
        toggleOceanWalk(true)   

        task.wait(2) 
        toggleTakeFood(true)
        
        StarterGui:SetCore("SendNotification", { Title = "자동 설정 완료", Text = "특정 게임(ID:"..targetPlaceId..") 설정이 적용되었습니다.", Duration = 5 })
    end)
    
    task.spawn(function()
        task.wait(5)
        toggleAntiInPlots(true)
    end)

    task.spawn(function()
        task.wait(5)
        local grabEvents = ReplicatedStorage:WaitForChild("GrabEvents", 5)
        if grabEvents then
            local endGrabEarly = grabEvents:WaitForChild("EndGrabEarly", 5)
            if endGrabEarly then
                endGrabEarly:Destroy()
                local dummyEvent = Instance.new("RemoteEvent")
                dummyEvent.Name = "EndGrabEarly"
                dummyEvent.Parent = grabEvents
            end
        end
    end)

else
end


StarterGui:SetCore("SendNotification", { Title = "v9.6 스크립트 로드됨", Text = "; 키로 커맨드바 열기 / .help를 이용해서 명령어 목록 보기", Duration = 7 })

chatConnection = lp.Chatted:Connect(function(msg)
    local cleanMsg = msg:gsub("^%s+", "")
    if cleanMsg:sub(1, 1) == "." then processCommand(cleanMsg) end
end)

mainInputConnection = UserInputService.InputBegan:Connect(function(input, gpe)
    if gpe then return end
    if input.KeyCode == Enum.KeyCode.Semicolon then
        if not cmdFrame.Visible then
            if cmdShow then pcall(cmdShow) end
            if cmdInput then cmdInput.Text = ""; task.wait(); pcall(function() cmdInput:CaptureFocus() end); cmdFocused = true end
        else
            pcall(function() if cmdInput then cmdInput:ReleaseFocus() end end)
            if cmdHide then pcall(cmdHide) end; cmdFocused = false
        end
    end
end)

print("v9.6 명령어 스크립트가 로딩 되었습니다 --")

local function cleanup()
    walkflingEnabled = false
    stopFlying() 
    togglePlcd(false) 
    toggleAutoReset(false) 
    toggleTakeFood(false) 
    toggleAntiBomb(false) 
    toggleAntiInPlots(false) 
    toggleDelLines(false) 
    toggleSpin(false)
end

game:BindToClose(cleanup)
